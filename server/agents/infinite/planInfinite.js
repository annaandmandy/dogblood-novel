import {
    callDeepSeek,
    getGeminiModel,
    cleanJson,
    ANTI_CLICHE_INSTRUCTIONS,
    getToneInstruction,
    getPovInstruction,
} from "../../lib/llm.js";

import { supabase } from '../../lib/supabase.js';

// ==========================================
// ğŸ² Smart Theme Pool (ç™¾å¤§å‰¯æœ¬åº« - å®Œæ•´ç‰ˆ)
// ==========================================
const THEME_POOL = {
    // ğŸ« ç¾ä»£/éƒ½å¸‚éˆç•° (é©åˆæ–°æ‰‹/å‰æœŸ)
    modern: [
        "æ·±å¤œæ ¡åœ’", "404è™Ÿå…¬å¯“", "å»¢æ£„é†«é™¢", "åˆå¤œæœ«ç­è»Š", "ç„¡äººä¾¿åˆ©åº—",
        "è©­ç•°éŠæ¨‚åœ’", "æ­»äº¡ç›´æ’­é–“", "é¬§é¬¼é›»å½±é™¢", "æ•´å½¢ç¾å®¹é™¢", "çŒ›é¬¼å¤§å»ˆ",
        "é™°æ£®åœ–æ›¸é¤¨", "åœ°ä¸‹åœè»Šå ´", "æ¨¡ç‰¹å…’ç¶“ç´€å…¬å¸", "æ·±å±±ç™‚é¤Šé™¢", "é›¨å¤œå± å¤«æ¡ˆ",
        "é€ƒé›¢ç¶²æˆ’ä¸­å¿ƒ", "ç„¡é™é›»æ¢¯", "éˆç•°ç…§ç›¸é¤¨", "è Ÿåƒé¤¨é©šé­‚", "ç©å¶å·¥å» ",
        "å¤ªå¹³é–“å¤œç­", "éƒ½å¸‚å‚³èªªä¿±æ¨‚éƒ¨", "å»¢æ£„åœ°éµç·š", "è‡ªæ®ºç›´æ’­é–“", "ç¶²ç´…é¬¼å±‹æ¢éšª",
        "ææ€–å¿«éç«™", "é›¨å¤œè¨ˆç¨‹è»Š", "é¡ä¸­å…¬å¯“", "è¿´è²èµ°å»Š", "é„°å±…çš„æ—¥è¨˜",
        "ç›´æ’­å¸¶è²¨çš„è©›å’’", "æ•¸å­—è©›å’’ä¿¡", "é›»å­å¯µç‰©å¾©ä»‡", "æ™ºèƒ½å®¶å±…å¤±æ§", "è™›æ“¬å¶åƒé¬¼é­‚",
        "åŠ ç­å¤§æ¨“çš„æ€¨å¿µ", "å…±äº«å–®è»Šå¢³å ´", "å¤–è³£å“¡çš„æœ«è·¯", "KTVæœ€å¾Œä¸€é–“", "å¯†å®¤é€ƒè„«çœŸäººç‰ˆ",
        "ç¶²å§åŒ…å¤œé©šé­‚", "å¿«éæ«ƒè£¡çš„ç§˜å¯†", "åˆç§Ÿæˆ¿ç¦å¿Œ", "é›»æ¢¯ç¶­ä¿®æ—¥", "åœé›»çš„è³¼ç‰©ä¸­å¿ƒ",
        "æœ«æ—¥é è¨€èŠå¤©ç¾¤", "ç›¸è¦ªå°è±¡æ˜¯é¬¼", "å¯µç‰©ç›£æ§çš„çœŸç›¸", "éºç‰©æ•´ç†å¸«", "æœ€å¾Œä¸€ç­æ¸¡è¼ª"
    ],

    // ğŸ® ä¸­å¼/æ°‘ä¿—ææ€– (é©åˆä¸­å¼ææ€– Tag)
    chinese: [
        "å†¥å©šå¤å®…", "æ¹˜è¥¿è¶•å±", "å°é–€é¬¼æ‘", "æˆ²ç­é©šé­‚", "é»ƒçš®å­å¢³",
        "é™°é™½å®¢æ£§", "è‹—ç–†è ±å¯¨", "é–é¾äº•", "ç´™äººå›é­‚å¤œ", "ç¾©èŠå®ˆå¤œ",
        "å¥ˆä½•æ©‹é‚Š", "ç¹¡èŠ±é‹è€å®…", "çš®å½±æˆ²ç­", "é•·ç”Ÿé‚ªæ•™", "è¡€ç¥­é¾ç‹å»Ÿ",
        "å±±æ‘è€å±", "ç‹ä»™å»Ÿ", "é¬¼å¸‚äº¤æ˜“", "æ®­å±ç‹çˆº", "äº”è¡Œæ®ºé™£",
        "æ°´é¬¼æ‹‰æ›¿èº«", "åŠæ­»é¬¼æ—", "æ–·é ­æ–°å¨˜", "ç•«çš®å¦–", "å¤é¡æ”é­‚",
        "å€Ÿé™°å£½", "é¤Šå°é¬¼", "è¶•å±å®¢æ£§", "é¬¼æ‰“ç‰†å±±æ‘", "æ’ˆå±äºº",
        "é™°å…µå€Ÿé“", "é¬¼å¬°å“­å¢³", "æ²³ç¥å¨¶è¦ª", "ç¥–å¢³é¢¨æ°´å±€", "æ‰“ç”Ÿæ¨",
        "ç´®ç´™è¡“å‚³æ‰¿", "è¶•æµ·é‡æµ·é¬¼", "é¾è„ˆé®å£“", "é¬¼æˆ²å°", "æ­»äººå¦",
        "é™°å®…ä¸­ä»‹", "é¬¼ç•¶é‹ª", "èƒŒå±å·¥", "å•ç±³å©†", "èµ°é™°äºº",
        "æ£ºæé‹ªç§˜è", "å±è®Šå®¢æ£§", "é¬¼æŠ¬è½", "é™°èƒ", "éª¨ç°ç›’çš„è©›å’’",
        "å¤œå“­éƒ", "é¬¼å‰ƒé ­", "é¤“é¬¼é“", "é™°å¸è·¯å¼•", "åœ°åºœå¿«é"
    ],

    // ğŸ° è¥¿å¼/å®—æ•™/å…‹è˜‡é­¯ (é©åˆè¥¿å¹»/å…‹è˜‡é­¯ Tag)
    western: [
        "å¾·å¤æ‹‰åŸå ¡", "é–‹è†›æ‰‹å‚‘å…‹", "å¡å‹’å§†å¥³å·«å¯©åˆ¤", "å¯‚éœå¶ºè¿·éœ§", "è¡€è…¥ç‘ªéº—",
        "èˆŠæ—¥æ”¯é…è€…ç¥­å£‡", "æ·±æµ·æ‹‰èŠè€¶", "ç˜‹ç‹‚ä¿®é“é™¢", "æƒ¡é­”å¬å–šå„€å¼", "ææ€–å­¤å…’é™¢",
        "æº«å¾¹æ–¯ç‰¹é¬¼å±‹", "äººçš®å®¢æ£§", "å–ªå±åœåŸ", "å¼—è˜­è‚¯æ–¯å¦å¯¦é©—å®¤", "å¸è¡€é¬¼èˆæœƒ",
        "ç‹¼äººæ‘è½", "æƒ¡éˆé™„èº«", "è©›å’’äººå¶å®‰å¨œè²çˆ¾", "æ·±æ·µå‡è¦–", "é»‘å½Œæ’’",
        "è–å¬°éºéª¸", "æ‡ºæ‚”å®¤ç§˜å¯†", "è–æ°´æ±¡æŸ“", "è¤»ç€†æ•™å ‚", "ç•°ç«¯å¯©åˆ¤æ‰€",
        "æ­»éˆæ³•å¸«å¡”", "åœ°ç„é‚Šå¢ƒ", "é­”é¬¼å¥‘ç´„", "ä¸ƒå®—ç½ªè©¦ç…‰", "å¤©ä½¿å¢®è½æ—¥",
        "é»‘æ­»ç—…é†«ç”Ÿ", "æ´»é«”æ¨™æœ¬é¤¨", "ç•¸å½¢ç§€é¦¬æˆ²åœ˜", "äººé«”èœˆèš£å¯¦é©—", "éˆé­‚äº¤æ›å„€å¼",
        "åœ°ç„å»šæˆ¿", "è©›å’’æ²¹ç•«", "é¬¼ä¿®å¥³", "é‚ªç¥èƒå…’", "é£Ÿäººé­”èŠåœ’",
        "ç˜Ÿç–«é†«ç”Ÿé¢å…·", "æ´»åŸ‹ä¿±æ¨‚éƒ¨", "äººé«”è Ÿåƒ", "ç˜‹äººé™¢åœ°ä¸‹", "ç»ç¥­ä¹‹å¤œ",
        "å¤ç¥ä½èª", "æ·±æµ·ææ‡¼ç—‡", "æ˜Ÿç©ºç˜‹ç‹‚", "ä¸å¯åç‹€ä¹‹ç‰©", "å®‡å®™ææ€–",
        "é»ƒè¡£ä¹‹ç‹", "å¥ˆäºæ‹‰æ‰˜ææ™®", "é˜¿æ’’æ‰˜æ–¯ä¹‹å¤¢", "é å¤è€…éºè·¡", "æ˜Ÿä¹‹å½©"
    ],

    // ğŸš€ ç§‘å¹»/æœªä¾†/æ”¶å®¹ (é©åˆæ˜Ÿéš›/è³½åš Tag)
    scifi: [
        "SCPæ”¶å®¹å¤±æ•ˆ", "AIæš´èµ°éƒ½å¸‚", "å¤ªç©ºå¹½éˆèˆ¹", "ç”ŸåŒ–å±æ©Ÿå¯¦é©—å®¤", "è³½åšè²§æ°‘çªŸ",
        "è¤‡è£½äººå·¥å» ", "è™›æ“¬ç¾å¯¦å´©å£", "ç¼¸ä¸­ä¹‹è…¦", "æ©Ÿæ¢°å…¬æ•µ", "ç•°å½¢æ¯å·¢",
        "æ™‚ç©ºæŠ˜ç–Šç«™", "æ ¸è¼»å°„å»¢åœŸ", "åŸºå› æ”¹é€ ç‡Ÿ", "é‡å­å¹½éˆ", "çŸ©é™£é‡å•Ÿ",
        "åçƒæ‰˜é‚¦ç›£ç„", "è¨˜æ†¶æå–ä¸­å¿ƒ", "æ·±æµ·åŸºåœ°", "æœˆçƒèƒŒé¢", "ç¡…åŸºç”Ÿç‰©å…¥ä¾µ",
        "æ™ºæ¢°å±æ©Ÿ", "æ„è­˜ä¸Šå‚³å¤±æ•—", "æ™‚é–“æ‚–è«–ç›£ç„", "å¹³è¡Œå®‡å®™äº¤åŒ¯", "å…‹é­¯è˜‡AI",
        "æ•¸å­—é¬¼é­‚", "è³½åšç²¾ç¥ç—…é™¢", "ç¾©é«”æ’æ–¥åæ‡‰", "è…¦æ©Ÿæ¥å£ç—…æ¯’", "å…¨æ¯å¹»å¢ƒå´©å£",
        "æˆ´æ£®çƒæ•…éšœ", "èŸ²æ—å…¥ä¾µ", "æ˜Ÿéš›é›£æ°‘èˆ¹", "é»‘æ´é‚Šç·£ç«™", "é‡å­ç³¾çºè©›å’’",
        "è¨˜æ†¶ç¯¡æ”¹å…¬å¸", "æƒ…æ„Ÿåˆªé™¤æœå‹™", "æ°¸ç”Ÿä»£åƒ¹", "å…‹éš†é«”å›äº‚", "ç´ç±³æ©Ÿå™¨äººç˜Ÿç–«",
        "è™›æ“¬å¶åƒè¦ºé†’", "æ•¸æ“šå¹½éˆå¾©ä»‡", "å…ƒå®‡å®™å´©æ½°", "æ„è­˜å›šç± ", "éˆé­‚å‚™ä»½ç«™",
        "æ™‚é–“å›æº¯å¤±æ•—", "å› æœå¾‹æ­¦å™¨å¤±æ§", "é«˜ç¶­ç”Ÿç‰©è§€å¯Ÿ", "æ–‡æ˜é‡ç½®å™¨", "å®‡å®™æ­¸é›¶",
        "å¤–æ˜Ÿéºç‰©æ„ŸæŸ“", "æ˜Ÿéš›ææ‡¼ç—‡", "ç¶­åº¦è£‚ç¸«", "åç‰©è³ªæ³„éœ²", "å¥‡é»é™è‡¨"
    ],

    // âš”ï¸ ç”Ÿå­˜/å¤§é€ƒæ®º/è¦å‰‡ (é©åˆç„¡é™æµ/è¦å‰‡æ€ªè«‡)
    survival: [
        "çµ•åœ°æ±‚ç”Ÿå³¶", "æ­»äº¡è¿·å®®", "é£¢é¤“éŠæˆ²", "ä¿„ç¾…æ–¯è¼ªç›¤è³­å ´", "æš´é¢¨é›ªå±±èŠ",
        "äºé¦¬éœé£Ÿäººæ—", "æ³°å¦å°¼å…‹è™Ÿæ²‰æ²’å¤œ", "é¾è²å¤åŸæœ«æ—¥", "åˆ‡çˆ¾è«¾è²åˆ©", "è¿·éœ§æ£®æ—",
        "è¦å‰‡æ€ªè«‡ï¼šå‹•ç‰©åœ’", "è¦å‰‡æ€ªè«‡ï¼šåª½åª½çš„ç´™æ¢", "ä¸ƒæ—¥æ®º", "æ­»äº¡åˆ—è»Š", "å¤©ç©ºé¬¥æŠ€å ´",
        "è¬Šè¨€ä¹‹åŸ", "ç¦æ­¢å‘¼å¸", "é»‘æš—ç«¥è©±é®", "æ„›éº—çµ²å¤¢éŠä»™å¢ƒ", "ç„¡ç›¡è¿´å»Š",
        "å¤§é€ƒæ®ºæ ¡åœ’", "æ®ºäººéŠæˆ²åˆ¥å¢…", "å®šæ™‚ç‚¸å½ˆåŸå¸‚", "å€–å­˜è€…åé¡çˆ­å¥ª", "æ°§æ°£è€—ç›¡ç©ºé–“ç«™",
        "æ·±æµ·æ½›è‰‡å›°å¢ƒ", "æ²™æ¼ æ±‚ç”Ÿ", "æ¥µåœ°è€ƒå¯Ÿç«™", "ç«å±±çˆ†ç™¼å‰å¤œ", "éš•çŸ³æ’æ“Šå€’æ•¸",
        "å–ªå±åœåŸåæ—¥", "ç—…æ¯’æ„ŸæŸ“éš”é›¢å€", "é£Ÿäººæ—éƒ¨è½", "åŸå§‹æ£®æ—æ±‚ç”Ÿ", "ç„¡äººè’å³¶",
        "è¦å‰‡æ€ªè«‡ï¼šå…¬å¸", "è¦å‰‡æ€ªè«‡ï¼šå­¸æ ¡", "è¦å‰‡æ€ªè«‡ï¼šé†«é™¢", "è¦å‰‡æ€ªè«‡ï¼šæ—…é¤¨", "è¦å‰‡æ€ªè«‡ï¼šéŠè¼ª",
        "æ­»äº¡éŠæˆ²ç›´æ’­", "è³­å‘½æ“‚å°", "è‡´å‘½æ‰è¿·è—", "æ®ºæ‰‹èˆ‡å¹³æ°‘", "æœ€å¾Œçš„æ™šé¤",
        "æ™‚é™è¿·å®®", "æ©Ÿé—œåŸå ¡", "æ¯’æ°£å¯†å®¤", "æ´ªæ°´å€’çŒ", "é«˜æº«ç†”çˆ",
        "å†°å°æœ«æ—¥", "é…¸é›¨ä¾µè•", "è¼»å°„å»¢åœŸ", "ç£æ¥µç¿»è½‰", "å¤ªé™½è€€æ–‘"
    ],

    // ğŸŒŸ æ–°å¢é¡åˆ¥ï¼šæ··åˆ/è·¨ç•Œ/å‰µæ„é¡
    hybrid: [
        "è³½åšé¬¼åŸ", "AIè©›å’’", "æ©Ÿæ¢°å¹½éˆ", "æ•¸å­—æ‹›é­‚", "è™›æ“¬åœ°ç„",
        "ç¾©é«”é¬¼é­‚", "å…¨æ¯é¬¼å±‹", "ç´ç±³è©›å’’", "é‡å­é¬¼é­…", "æ™‚é–“å¹½éˆ",
        "éƒ½å¸‚ç‹ä»™", "åœ°éµé™°å…µ", "å¯«å­—æ¨“é¤Šå±", "å¿«éé¬¼å¦»", "ç¶²ç´…é»ƒçš®å­",
        "å…±äº«å–®è»Šå€Ÿé™°å‚µ", "å¤–è³£é¤“é¬¼", "ç›´æ’­é©…é­”", "é›»ç«¶é€šéˆ", "æ»´æ»´é¬¼è»Š",
        "èˆŠæ—¥æ”¯é…è€…çš„å…¬å¸", "æ·±æ½›è€…åœ°éµ", "æ˜Ÿç©ºç˜‹äººé™¢", "å¤ç¥ç›´æ’­é–“", "é‚ªç¥å¤–è³£",
        "å…‹è˜‡é­¯è¦å‰‡æ€ªè«‡", "æ·±æ·µé›»æ¢¯", "ä¸å¯åç‹€çš„å­¸æ ¡", "æ˜Ÿç©ºææ‡¼éŠæ¨‚åœ’", "å¤ç¥è©›å’’APP",
        "è¡¨æƒ…åŒ…è©›å’’", "emojiæ®ºäººäº‹ä»¶", "çŸ­è¦–é »å¾ªç’°åœ°ç„", "å½ˆå¹•é¬¼é­‚", "é›²ç«¯é¬¼é­‚",
        "Wi-Fiæ‹›é­‚", "è—ç‰™é™„èº«", "äºŒç¶­ç¢¼è©›å’’", "ç¶²ç´…æ¿¾é¡çœŸç›¸", "ç®—æ³•æ®ºäºº",
        "å…µé¦¬ä¿‘å¾©æ´»", "æ•…å®®å¤œå·¡", "é‡‘å­—å¡”è©›å’’", "ç‰¹æ´›ä¼Šæœ¨é¦¬ç—…æ¯’", "ç¶­äº¬é¬¼èˆ¹",
        "ç‘ªé›…é è¨€æœ«æ—¥", "ç§¦å§‹çš‡æ°¸ç”Ÿè¨ˆåŠƒ", "æœ¨ä¹ƒä¼Šå¿«é", "é¨å£«äº¡é­‚", "æ­¦å£«æ€¨éˆ"
    ],

    // ğŸ­ æ–°å¢é¡åˆ¥ï¼šå¿ƒç†/è¶…ç¾å¯¦/æŠ½è±¡
    psychological: [
        "è¨˜æ†¶è¿·å®®", "å¤¢å¢ƒå›šç± ", "æ„è­˜æ·±æ·µ", "äººæ ¼åˆ†è£‚è¨ºæ‰€", "ç¾å¯¦æ‰­æ›²ç—…æˆ¿",
        "æ™‚é–“æ„ŸçŸ¥å¤±èª¿", "ç©ºé–“èªçŸ¥å´©å£", "æ„Ÿå®˜å‰å¥ªå¯¦é©—", "é›†é«”å¹»è¦ºå°é®", "å­˜åœ¨å±æ©Ÿå±æ©Ÿ",
        "é‚è¼¯åœ°ç„", "æ‚–è«–æˆ¿é–“", "è‡ªæŒ‡è©›å’’", "ç„¡é™è¿´åœˆå…¬å¯“", "è‡ªæˆ‘åå™¬ç©ºé–“",
        "ä»–è€…åœ°ç„", "é¡åƒç›£ç„", "è²éŸ³å¯¦é«”åŒ–", "è‰²å½©æ®ºäºº", "å¹¾ä½•ææ‡¼",
        "èªè¨€ç—…æ¯’", "æ€æƒ³æ±¡æŸ“", "æ¦‚å¿µå¯¦é«”", "æŠ½è±¡ææ‡¼", "å½¢è€Œä¸Šè©›å’’",
        "å­˜åœ¨æ€§è™›ç„¡", "æ„ç¾©å´©å¡Œ", "èªçŸ¥é‚Šç•Œ", "ç†æ€§ç›¡é ­", "ç˜‹ç‹‚è‡¨ç•Œé»"
    ],

    // ğŸ›ï¸ æ–°å¢é¡åˆ¥ï¼šæ­·å²/ç¥è©±/å‚³èªªæ”¹ç·¨
    historical: [
        "ç‰¹æ´›ä¼Šä¹‹å¤œ", "é¾è²æœ€å¾Œä¸€å¤œ", "åœ“æ˜åœ’é¬¼å½±", "å…µé¦¬ä¿‘è˜‡é†’", "ç‘ªé›…è¡€ç¥­",
        "äºç‰¹è˜­è’‚æ–¯å›æ­¸", "æ¨“è˜­é¬¼åŸ", "å³å“¥çªŸè©›å’’", "å°åŠ é»ƒé‡‘åŸ", "æ‰€ç¾…é–€å¯¶è—",
        "è–æ¯è©›å’’", "ç´„æ«ƒæ®ºæ©Ÿ", "æ­»æµ·å¤å·ç§˜å¯†", "è«¾äºæ–¹èˆŸæ®˜éª¸", "å·´åˆ¥å¡”éºè·¡",
        "å¥§æ—åŒ¹æ–¯ç¥æ€’", "åŒ—æ­è«¸ç¥é»ƒæ˜", "åŸƒåŠåç½é‡ç¾", "å·´æ¯”å€«ç©ºä¸­èŠ±åœ’", "æ³¢æ–¯ä¸æ­»è»",
        "åŒˆå¥´ç‹é™µå¢“", "æˆå‰æ€æ±—ç§˜è‘¬", "ç§¦å§‹çš‡åœ°å®®", "æ­¦å‰‡å¤©ç„¡å­—ç¢‘", "å¤§æ˜å’’è¡“æ¡ˆ",
        "ç¶­äº¬è‹±éˆæ®¿", "é¨å£«åœ˜ç§˜å¯¶", "å¥³å·«å¯©åˆ¤å¤œ", "æµ·ç›œé¬¼èˆ¹", "è¥¿éƒ¨äº¡é­‚é®"
    ],

    // ğŸª æ–°å¢é¡åˆ¥ï¼šå¨›æ¨‚/æµè¡Œæ–‡åŒ–æ¢—
    popculture: [
        "ç¶œè—å¤§é€ƒæ®º", "çœŸäººç§€åœ°ç„", "å¶åƒé¤Šæˆè©›å’’", "é›»ç«¶é¸æ‰‹äº¡é­‚", "ä¸»æ’­é€£ç·šé¬¼",
        "é›»å½±æ‹æ”äº‹æ•…", "åŠ‡çµ„é¬§é¬¼äº‹ä»¶", "æ¼«å±•å…‹è˜‡é­¯", "åŒäººå±•ç•°è®Š", "Cosplayæ®ºäººäº‹ä»¶",
        "éŠæˆ²å¯¦é«”åŒ–", "å‰¯æœ¬æˆçœŸ", "è£å‚™å…·ç¾åŒ–", "æŠ€èƒ½è¦ºé†’æ—¥", "æ°ªé‡‘è©›å’’",
        "çŸ­è¦–é »æŒ‘æˆ°æ­»äº¡", "ç›´æ’­PKåœ°ç„", "å½ˆå¹•æ®ºäºº", "è©•è«–å€é¬¼é­‚", "é»è´Šè©›å’’",
        "å¾®åšç†±æœè©­äº‹", "æœ‹å‹åœˆéˆç•°", "å¾®ä¿¡ç¾¤æ­»äº¡éŠæˆ²", "çŸ¥ä¹æ€ªè«‡æˆçœŸ", "Bç«™é¬¼ç•œå¯¦é«”åŒ–"
    ],

    // ğŸŒŒ æ–°å¢é¡åˆ¥ï¼šå®‡å®™/é«˜ç¶­/çµ‚æ¥µææ€–
    cosmic: [
        "å®‡å®™æ­¸é›¶", "ç†±å¯‚å‰å¤•", "çœŸç©ºè¡°è®Š", "å¥‡é»é™è‡¨", "ç¶­åº¦åå¡Œ",
        "æ™‚é–“ç›¡é ­", "å› æœå´©å£", "ç‰©ç†æ³•å‰‡å¤±æ•ˆ", "æ•¸å­¸åœ°ç„", "é‚è¼¯æœ«æ—¥",
        "è§€å¯Ÿè€…æ•ˆæ‡‰ææ€–", "é‡å­è‡ªæ®º", "å¹³è¡Œå®‡å®™æ±¡æŸ“", "å¤šä¸–ç•Œè©›å’’", "é€€ç›¸å¹²åœ°ç„",
        "é»‘æ´ä¿¡æ¯æ‚–è«–", "ç™½æ´å™´ç™¼", "èŸ²æ´è¿·å¤±", "æ›²é€Ÿå¼•æ“æ•…éšœ", "è¶…å…‰é€Ÿè©›å’’",
        "å®‡å®™èƒŒæ™¯è¼»å°„ä½èª", "æš—ç‰©è³ªå¯¦é«”", "æš—èƒ½é‡ä¾µè•", "å¼¦ç†è«–å™©å¤¢", "Mç†è«–åœ°ç„",
        "é«˜ç¶­ç”Ÿç‰©é£¼é¤Šå ´", "å®‡å®™è¾²å ´ä¸»å‡èªª", "ç¼¸ä¸­ä¹‹è…¦é›†ç¾¤", "æ¨¡æ“¬ä¸–ç•Œå´©æ½°", "é€ ç‰©ä¸»æ£„å‘"
    ]
};

// ==========================================
// ğŸŒŒ Infinite Flow Archetypes (ç„¡é™æµé¡å‹çŸ©é™£)
// ==========================================
const INFINITE_ARCHETYPES = {
    // 1. å­¸æ ¡/è€ƒè©¦å‹ (Global Exam Style)
    school: {
        trigger: ["æ ¡åœ’", "è€ƒè©¦", "å­¸éœ¸", "è¼•é¬†"],
        description: "ä»¥ã€Œè’èª•å­¸æ ¡ã€ç‚ºä¸»ä¸–ç•Œã€‚ç©å®¶æ˜¯å­¸ç”Ÿï¼Œå‰¯æœ¬æ˜¯è€ƒè©¦ï¼Œæ­»äº¡æ˜¯é€€å­¸ã€‚é¢¨æ ¼é€šå¸¸å¸¶æœ‰é»‘è‰²å¹½é»˜æˆ–è¦å‰‡æ€ªè«‡æ„Ÿã€‚"
    },
    // 2. ç›´æ’­/å¨›æ¨‚åœˆå‹ (Streamer/Showbiz)
    stream: {
        trigger: ["ç›´æ’­", "ç¶²ç´…", "å¨›æ¨‚åœˆ", "å½ˆå¹•", "çˆ½æ–‡"],
        description: "ä»¥ã€Œæ­»äº¡ç›´æ’­é–“ã€æˆ–ã€Œé©šæ‚šç¶œè—ã€ç‚ºä¸»ä¸–ç•Œã€‚ç©å®¶æ˜¯ä¸»æ’­/æ¼”å“¡ï¼Œç©åˆ†æ˜¯æ‰“è³/æ”¶è¦–ç‡ã€‚é‡é»åœ¨æ–¼è§€çœ¾äº’å‹•èˆ‡äººè¨­æ‰®æ¼”ã€‚"
    },
    // 3. è¼‰å…·/æ—…è¡Œå‹ (Transport/Journey)
    transport: {
        trigger: ["åˆ—è»Š", "å…¬è»Š", "éƒµè¼ª", "æ—…è¡Œ", "å…¬è·¯æ–‡"],
        description: "ä»¥ã€Œå¹½éˆè¼‰å…·ã€ç‚ºä¸»ä¸–ç•Œï¼ˆå¦‚444è™Ÿåˆ—è»Šï¼‰ã€‚ç©å®¶æ˜¯ä¹˜å®¢ï¼Œå‰¯æœ¬æ˜¯ç«™é»ã€‚é‡é»åœ¨æ–¼å°é–‰ç©ºé–“çš„ç›¸è™•èˆ‡æ—…é€”æ„Ÿã€‚"
    },
    // 4. éŠæˆ²/æ•¸æ“šå‹ (VR/Game/Cyber)
    game: {
        trigger: ["ç¶²éŠ", "é›»ç«¶", "ç³»çµ±", "æ•¸æ“š", "è³½åš", "å‡ç´š"],
        description: "ä»¥ã€Œè™›æ“¬ä¸»åŸã€æˆ–ã€Œç™»éŒ„ç©ºé–“ã€ç‚ºä¸»ä¸–ç•Œã€‚ç©å®¶æ˜¯æ•¸æ“šåŒ–è§’è‰²ï¼Œæœ‰æ˜ç¢ºçš„é¢æ¿ã€å…¬æœƒå’Œæ’è¡Œæ¦œã€‚é¢¨æ ¼åå‘RPGæˆ–æ•¸æ“šæµã€‚"
    },
    // 5. æ¨“å®‡/å°é–‰ç¤¾å€å‹ (Apartment/Tower)
    building: {
        trigger: ["å…¬å¯“", "é„°å±…", "é«˜å¡”", "å±¤ç´š", "æ±‚ç”Ÿ"],
        description: "ä»¥ã€Œç¥ç§˜å…¬å¯“ã€æˆ–ã€Œå·´åˆ¥å¡”ã€ç‚ºä¸»ä¸–ç•Œã€‚ç©å®¶æ˜¯ä½æˆ¶ï¼Œå‰¯æœ¬æ˜¯æ¨“å±¤æˆ–é„°å±…æˆ¿é–“ã€‚é‡é»åœ¨æ–¼é„°é‡Œé—œä¿‚èˆ‡é ˜åœ°å»ºè¨­ã€‚"
    },
    // 6. æ‰‹æ©Ÿ/APPå‹ (App/Modern)
    app: {
        trigger: ["æ‰‹æ©Ÿ", "APP", "éƒ½å¸‚", "éˆç•°", "æ—¥å¸¸"],
        description: "ä»¥ã€Œç¾å¯¦ä¸–ç•Œã€ç‚ºä¸»ä¸–ç•Œï¼Œé€šéæ‰‹æ©ŸAPPç™¼å¸ƒä»»å‹™ã€‚å‰¯æœ¬èå…¥ç¾å¯¦ç”Ÿæ´»ï¼ˆå¦‚åˆå¤œçš„è¾¦å…¬å®¤ï¼‰ã€‚é‡é»æ˜¯ç¾å¯¦èˆ‡ææ€–çš„é‚Šç•Œæ¨¡ç³Šã€‚"
    },
    // 7. ç¶“å…¸ä¸»ç¥å‹ (Classic God Space)
    classic: {
        trigger: ["ä¸»ç¥", "ç„¡é™", "æœ«ä¸–", "å‚³çµ±"],
        description: "ç¶“å…¸çš„ã€Œç™½è‰²ç©ºé–“ã€æˆ–ã€Œå¤§å…‰çƒã€ã€‚å¼·èª¿æ®˜é…·çš„æŠ¹æ®ºè¦å‰‡ã€å¼·åŒ–å…Œæ›èˆ‡åœ˜éšŠæ±‚ç”Ÿã€‚"
    },
    building: {
        trigger: ["å…¬å¯“", "é„°å±…", "é«˜å¡”", "æ±‚ç”Ÿ", "ç± å±‹", "æˆ¿å®¢", "ç§Ÿé‡‘", "æ¨“"], // ğŸ‘ˆ å¢åŠ ã€Œç± å±‹ã€ã€ã€Œæˆ¿å®¢ã€
        description: "ä»¥ã€Œç¥ç§˜å…¬å¯“ã€æˆ–ã€Œå·´åˆ¥ç± å±‹ã€ç‚ºä¸»ä¸–ç•Œã€‚ç©å®¶æ˜¯ä½æˆ¶ï¼Œå‰¯æœ¬æ˜¯é„°å±…çš„æˆ¿é–“ã€‚é‡é»åœ¨æ–¼ï¼šç‹¹çª„ç©ºé–“çš„å£“æŠ‘æ„Ÿã€é„°é‡Œé—œä¿‚çš„çŒœå¿Œã€ä»¥åŠå¿…é ˆç¹³ç´çš„ã€ç§Ÿé‡‘ã€ã€‚"
    }
};

// æ ¹æ“š Tags æ™ºèƒ½é¸æ“‡é¡å‹
const detectArchetype = (tags = []) => {
    for (const [key, type] of Object.entries(INFINITE_ARCHETYPES)) {
        if (type.trigger.some(t => tags.includes(t))) {
            return type; // å‘½ä¸­åŒ¹é…çš„é¡å‹
        }
    }
    // é»˜èªéš¨æ©Ÿé¸æ“‡ä¸€å€‹éå­¸æ ¡çš„é¡å‹ï¼ˆå¢åŠ å¤šæ¨£æ€§ï¼‰ï¼Œæˆ–è€…å›å‚³ null è®“ AI è‡ªç”±ç™¼æ®
    const types = Object.values(INFINITE_ARCHETYPES);
    return types[Math.floor(Math.random() * types.length)];
};

const INFINITE_STYLE_GUIDE = `
ã€ç„¡é™æµãƒ»å¯«ä½œé¢¨æ ¼æŒ‡å—ã€‘
1. **æ„Ÿå®˜æ²‰æµ¸**ï¼šä¸è¦å‘Šè¨´è®€è€…ã€Œå¾ˆææ€–ã€ï¼Œè¦æå¯«è…çˆ›çš„æ°£å‘³ã€ç²˜è†©çš„è§¸æ„Ÿã€è€³é‚Šçš„ä½èªã€‚
2. **å†·å¹½é»˜ (Cold Humor)**ï¼šä¸»è§’é¢å°ææ€–æ™‚è¦ä¿æŒä¸€ç¨®ã€Œå­ä¸–çš„å†·éœã€æˆ–ã€Œç˜‹æ‰¹çš„å„ªé›…ã€ã€‚
3. **Show, Don't Tell**ï¼šä¸è¦å¯«ã€Œä»–å¾ˆè°æ˜ã€ï¼Œå¯«ä»–å¦‚ä½•åœ¨å¿…æ­»çš„è¦å‰‡è£¡æ‰¾åˆ°æ¼æ´ä¸¦åŠ ä»¥åˆ©ç”¨ã€‚
4. **ä¸»ä¸–ç•Œå³æˆ°å ´**ï¼šä¸»ä¸–ç•Œï¼ˆå­¸æ ¡/å…¬å¯“/ç›´æ’­é–“ï¼‰ä¸æ˜¯å®‰å…¨å€ï¼Œè€Œæ˜¯å¦ä¸€å€‹å……æ»¿å£“æŠ‘è¦å‰‡çš„ç¤¾æœƒã€‚
5. **CP å¼µåŠ›**ï¼šæ‹’çµ•å·¥æ¥­ç³–ç²¾ã€‚è¦å¯«ç”Ÿæ­»é—œé ­çš„ã€Œå…±çŠ¯ã€æ„Ÿï¼Œçœ¼ç¥æ‹‰çµ²ï¼Œè‚¢é«”æ¥è§¸è¦å¯«å‡ºé›»æµæ„Ÿã€‚
`;

// å‹•æ…‹é¡¯åŒ–æŒ‡ä»¤ç”Ÿæˆå™¨ (çµ±ä¸€ç¬¬ä¸€ç« èˆ‡å¾ŒçºŒç« ç¯€çš„é¢¨æ ¼)
const getDynamicSettingPrompt = (settings) => {
    const combinedText = ((settings.summary || "") + JSON.stringify(settings.main_world_setting || "")).toLowerCase();

    if (combinedText.includes("ç›´æ’­") || combinedText.includes("ç¶œè—")) {
        return `ã€å¯«ä½œå¼·åˆ¶ï¼šç›´æ’­æµã€‘
        1. **é¡é ­æ„Ÿ**ï¼šæ™‚åˆ»æå¯«ä¸»è§’å°æ”åƒé ­çš„æ„è­˜ï¼ˆè¡¨æ¼”ã€èº²é¿ï¼‰ã€‚
        2. **å½ˆå¹•**ï¼šåœ¨åŠ‡æƒ…é—œéµé»ï¼ˆåè½‰/å—å‚·ï¼‰æ’å…¥è¦–ç¶²è†œä¸Šçš„å½ˆå¹•åæ‡‰ã€‚
        3. **å¿ƒæ…‹**ï¼šé€™æ˜¯ä¸€å ´å¨›æ¨‚è‡³æ­»çš„è¡¨æ¼”ã€‚`;
    }
    if (combinedText.includes("å…¬å¯“") || combinedText.includes("ç± å±‹")) {
        return `ã€å¯«ä½œå¼·åˆ¶ï¼šå…¬å¯“æµã€‘
        1. **ç©ºé–“æ„Ÿ**ï¼šå¼·èª¿ç‹¹çª„ã€æ½®æ¿•ã€éš”éŸ³å·®çš„å£“æŠ‘ç’°å¢ƒã€‚
        2. **é„°é‡Œ**ï¼šæå¯«å°é„°å±…çš„ææ‡¼èˆ‡çªºè¦–æ„Ÿã€‚
        3. **è¦å‰‡**ï¼šå¼·èª¿ã€Šå…¥ä½é ˆçŸ¥ã€‹æˆ–ã€Šç§Ÿç´„ã€‹çš„æŸç¸›ã€‚`;
    }
    if (combinedText.includes("å­¸æ ¡") || combinedText.includes("è€ƒè©¦")) {
        return `ã€å¯«ä½œå¼·åˆ¶ï¼šæ ¡åœ’æµã€‘
        1. **é«”åˆ¶åŒ–**ï¼šå¼·èª¿å»£æ’­ã€é˜è²ã€æ ¡è¦çš„æ©Ÿæ¢°æ„Ÿã€‚
        2. **ç«¶çˆ­**ï¼šæå¯«åŒå­¸ä¹‹é–“çš„æ•µæ„èˆ‡åˆ†æ•¸å£“åŠ›ã€‚`;
    }
    return "";
};

const selectDungeonTheme = (tags = [], cycleNum = 1, usedThemes = []) => {
    let availablePools = [];

    // å„ªå…ˆæ ¹æ“š Tag é–å®šé¡å‹ (Strict Mode)
    const isChinese = tags.includes("ä¸­å¼ææ€–") || tags.includes("å¤é¢¨") || tags.includes("ç›œå¢“");
    const isWestern = tags.includes("å…‹è˜‡é­¯") || tags.includes("è¥¿å¹»") || tags.includes("å¸è¡€é¬¼");
    const isSciFi = tags.includes("æ˜Ÿéš›") || tags.includes("è³½åšé¾å…‹") || tags.includes("ç§‘å¹»");

    if (isChinese) availablePools.push(...THEME_POOL.chinese);
    if (isWestern) availablePools.push(...THEME_POOL.western, ...THEME_POOL.cosmic);
    if (isSciFi) availablePools.push(...THEME_POOL.scifi);

    // åªæœ‰åœ¨æ²’æœ‰æ˜ç¢ºé¢¨æ ¼ Tag æ™‚ï¼Œæ‰æ··åˆ Generic pool
    if (!isChinese && !isWestern && !isSciFi) {
        availablePools.push(...THEME_POOL.modern, ...THEME_POOL.survival, ...THEME_POOL.hybrid, ...THEME_POOL.popculture);
        // å¾ŒæœŸæ‰æœƒå‡ºç¾é«˜ç»´ææ€–ï¼Œä¸”å¿…é ˆç¬¦åˆé‚è¼¯
        if (cycleNum > 6) availablePools.push(...THEME_POOL.cosmic, ...THEME_POOL.psychological);
    } else {
        // å¦‚æœæœ‰æ˜ç¢ºé¢¨æ ¼ï¼Œåªæ··å…¥å°‘é‡çš„é€šç”¨ææ€– (Modern/Survival)ï¼Œä¿æŒé¢¨æ ¼çµ±ä¸€
        availablePools.push(...THEME_POOL.modern, ...THEME_POOL.survival);
    }

    const freshThemes = availablePools.filter(theme => !usedThemes.includes(theme));
    const finalPool = freshThemes.length > 0 ? freshThemes : availablePools;
    return finalPool[Math.floor(Math.random() * finalPool.length)];
};

// å°ˆå±¬çš„é˜²å¥—è·¯æŒ‡ä»¤ (é‡å°ç„¡é™æµå„ªåŒ–)
const INFINITE_ANTI_CLICHE = `
${ANTI_CLICHE_INSTRUCTIONS}
ã€ç„¡é™æµç‰¹åŒ–ï¼šæ²ˆæµ¸å¼å¯«ä½œã€‘
1. **æ‹’çµ•èªªæ˜æ›¸**ï¼šå‰¯æœ¬è¦å‰‡æ˜¯ç”¨ä¾†ã€Œè§¸ç™¼ã€çš„ï¼Œä¸æ˜¯ç”¨ä¾†ã€ŒèƒŒèª¦ã€çš„ã€‚ä¸è¦èŠ±å¤§ç¯‡å¹…è§£é‡‹æ©Ÿåˆ¶ï¼Œè¦èŠ±ç¯‡å¹…æå¯«**åœ¨æ©Ÿåˆ¶ä¸‹çš„äººæ€§èˆ‡äº’å‹•**ã€‚
2. **äººç‰©å¼§å…‰**ï¼šä¸»è§’ä¸æ˜¯æ®ºäººæ©Ÿå™¨ã€‚è«‹æå¯«ä»–åœ¨æ®ºæˆ®å¾Œçš„ç–²æ†Šã€å°äººæ€§çš„å¤±æœ›ï¼Œä»¥åŠè¢« CP æ²»ç™’çš„ç¬é–“ã€‚
3. **ç¾å¯¦çš„é‡é‡**ï¼šå›åˆ°ç¾å¯¦ä¸–ç•Œ/ä¸»ä¸–ç•Œå¾Œï¼Œåå·®æ„Ÿè¦å¼·çƒˆã€‚
4. **æ¥µè‡´å¼µåŠ›**ï¼šä¸»è§’èˆ‡CPçš„é—œä¿‚æ‡‰è©²å……æ»¿å¼µåŠ›ã€‚
5. **ç¾¤åƒåˆ»ç•«**ï¼šéšŠå‹ä¸æ˜¯å ±å¹•å“¡ã€‚è«‹è³¦äºˆä»–å€‘é®®æ˜çš„æ€§æ ¼ã€‚
6. **è¦å‰‡ç ´å£è€…**ï¼šè®“ä¸»è§’é‘½è¦å‰‡æ¼æ´ï¼Œç”¨é‚è¼¯æ°£æ­»ç›£è€ƒå®˜/ç³»çµ±ï¼Œè€Œä¸æ˜¯å–®ç´”é æ­¦åŠ›ã€‚
7. **ä¸»ä¸–ç•Œåå·®**ï¼šå›åˆ°ä¸»ä¸–ç•Œå¾Œï¼Œåå·®æ„Ÿè¦å¼·çƒˆï¼Œæ‰èƒ½çªé¡¯å‰¯æœ¬å—å¾—ææ€–åˆºæ¿€ã€‚
8. è®€è€…æ˜¯ä¾†å—‘cpçš„ï¼Œè«‹è‘—é‡åœ¨cpçš„äº’å‹•å’Œæƒ…æ„Ÿæå†™ã€‚
`;

// æ–°å¢ï¼šä¸»è§’èªçŸ¥é™åˆ¶æŒ‡ä»¤ (é˜²æ­¢ä¸»è§’ä¸€é–‹å§‹å°±çŸ¥é“æ‰€æœ‰è¨­å®š)
const IGNORANCE_INSTRUCTION = `
ã€âš ï¸ èªçŸ¥é™åˆ¶ (Fog of War)ã€‘
- **ä¸»è§’æ˜¯æ–°äºº**ï¼šé™¤éè¨­å®šä¸­ä¸»è§’æ˜¯é‡ç”Ÿè€…ï¼Œå¦å‰‡**åš´ç¦**ä¸»è§’ä¸€é–‹å§‹å°±çŸ¥é“ã€Œä¸»ç¥ã€ã€ã€Œå‰¯æœ¬ã€ã€ã€Œç©åˆ†ã€ç­‰å°ˆæœ‰åè©ã€‚
- **å¾ªåºæ¼¸é€²**ï¼šä¸»è§’æ‡‰è©²å°çœ¼å‰çš„ä¸€åˆ‡æ„Ÿåˆ°å›°æƒ‘ã€ææ‡¼ã€æ‡·ç–‘ã€‚
- **æè¿°æ–¹å¼**ï¼šä¸è¦å¯«ã€Œç³»çµ±é¢æ¿å‡ºç¾ã€ï¼Œè¦å¯«ã€Œè¦–ç¶²è†œä¸Šçªå…€åœ°æµ®ç¾å‡ºä¸€è¡Œè¡€ç´…çš„å­—è·¡ã€ã€‚ä¸è¦å¯«ã€Œé€²å…¥äº†å‰¯æœ¬ã€ï¼Œè¦å¯«ã€Œæ¨é–‹é–€ï¼ŒåŸæœ¬ç†Ÿæ‚‰çš„èµ°å»Šè®Šæˆäº†ä¸€ç‰‡è’è•ªçš„å¢³å ´ã€ã€‚
`;

// ==========================================
// 1. è¨­å®šç”Ÿæˆ (generateInfiniteSettings)
// ==========================================
export const generateInfiniteSettings = async (tags = [], tone = "ä¸€èˆ¬", targetChapterCount = null, category = "BG", useDeepSeek = false) => {
    const toneDesc = getToneInstruction(tone);
    const totalChapters = targetChapterCount || 200;

    let genderConstraint = "";
    if (category === "BG") genderConstraint = "ä¸»è§’å¿…é ˆæ˜¯ä¸€ç”·ä¸€å¥³ (BG)ã€‚";
    else if (category === "BL") genderConstraint = "ä¸»è§’å¿…é ˆæ˜¯å…©ä½ç”·æ€§ (BL)ã€‚";
    else if (category === "GL") genderConstraint = "ä¸»è§’å¿…é ˆæ˜¯å…©ä½å¥³æ€§ (GL)ã€‚";

    const prompt = `
    ä½ æ˜¯ä¸€ä½é ‚ç´šç„¡é™æµå°èªªæ¶æ§‹å¸«ã€‚è«‹è¨­è¨ˆä¸€å¥—ç¨ç‰¹ã€æœ‰è¶£ä¸”è¨­å®šåš´å¯†çš„å°èªªè¨­å®šã€‚
    **é¡åˆ¥**ï¼š${category}ã€‚**ç¯‡å¹…**ï¼š${totalChapters} ç« ã€‚
    **æ¨™ç±¤**ï¼š${tags.join('ã€')}ã€‚**åŸºèª¿**ï¼š${toneDesc}
    ${genderConstraint}
    ${INFINITE_ANTI_CLICHE}
    
    ã€æ ¸å¿ƒä»»å‹™ã€‘
    1. **ä¸»ä¸–ç•Œ (Hub) æœ¬èº«å°±æ˜¯æœ‰è‡ªå·±çš„æ•…äº‹ç·šèˆ‡è¨­å®š**ï¼šä¸»ä¸–ç•Œä¸åªæ˜¯ä¼‘æ¯å€ï¼Œä¸»ä¸–ç•Œæœ‰è‡ªå·±ç¨ç‰¹çš„è¨­å®šï¼Œå¦‚ï¼šç¾ä»£/ç•°æ¬¡å…ƒ/ä½é­”/é«˜é­”ã€‚è‹¥ä¸»ä¸–ç•Œç‚ºç¾å¯¦ä¹Ÿå¯ä»¥ï¼Œ
    2. **è²¨å¹£èˆ‡æ‡²ç½°**ï¼šä¸è¦åªç”¨ã€Œç©åˆ†ã€ã€‚å¦‚ç›´æ’­æµç”¨ã€Œæ‰“è³/å£½å‘½ã€ã€æ ¡åœ’æµç”¨ã€Œå­¸åˆ†ã€ã€‚æ‡²ç½°ä¸åƒ…æ˜¯æŠ¹æ®ºã€‚
    3. **CP é—œä¿‚**ï¼šå¼·å¼µåŠ› CPï¼ˆå®¿æ•µ/å…±çŠ¯/æ•‘è´–ï¼‰ã€‚
    
    ã€å›å‚³ JSONã€‘
    {
      "title": "å°èªªæ¨™é¡Œ",
      "summary": "å¸ç›æ–‡æ¡ˆ (å«ä¸»ä¸–ç•ŒèƒŒæ™¯ã€é€²å…¥åŸå› ã€é‡‘æ‰‹æŒ‡)",
      "trope": "æ ¸å¿ƒæ¢—",
      "main_world_setting": {
          "name": "ä¸»ä¸–ç•Œåç¨± (å¦‚ï¼šè’è•ªå­¸åºœ / ç¬¬13ä¸­å­¸)",
          "type": "é¡å‹ (æ ¡åœ’/å…¬å¯“/åˆ—è»Š/ç›´æ’­ç­‰)",
          "entry_method": "é€²å…¥æ–¹å¼",
          "currency": "è²¨å¹£",
          "rules": ["æ ¡è¦1...", "æ ¡è¦2..."],
          "hierarchy": "éšç´šåˆ¶åº¦ (å¦‚ï¼šSç­æ“æœ‰ç”Ÿæ®ºå¤§æ¬Š)",
          "punishment": "æ‡²ç½°",
          "atmosphere": "æ°›åœ (å¦‚ï¼šè¡¨é¢æ­£å¸¸ä½†å¤©ç©ºæœ‰å·¨çœ¼)",
          "key_locations": ["åœ°é»1", "åœ°é»2", "åœ°é»3"],
          "conflict_sources": [
              "è¡çªæº1 (å¦‚ï¼šæ¨“é•·æ¯é€±æ”¶ã€è‚¢é«”ç¨…ã€)",
              "è¡çªæº2 (å¦‚ï¼šéš”å£ä½è‘—è®Šæ…‹æ®ºäººé­”)",
              "è¡çªæº3 (å¦‚ï¼šä¸»è§’è¢«åŸ·æ³•éšŠç›£è¦–)"
          ]
      },
      "design_blueprint": {
          "main_goal": "çµ‚æ¥µç›®æ¨™",
          "world_truth": "éš±è—çœŸç›¸",
          "ending_vision": "çµå±€",
          "side_characters": [ { "name": "...", "role": "...", "profile": "...", "speaking_style": "..." } ]
      },
      "protagonist": { "name": "...", "role": "ä¸»è§’", "gender": "...", "profile": { "appearance": "...", "personality": "...", "special_ability": "...", "background": "...", "speaking_style": "..." } },
      "loveInterest": { "name": "...", "role": "...", "gender": "...", "profile": { "appearance": "...", "personality": "...", "identity_in_world": "...", "speaking_style": "..." } },
      "relationships": [
          { "source": "Protagonist", "target": "LoveInterest", "type": "Stranger/Ex/Rival", "status": "Not Met", "description": "..." }
      ]
    }
    `;

    try {
        if (useDeepSeek) return await callDeepSeek("ä½ æ˜¯ä¸€ä½ç„¡é™æµæ¶æ§‹å¸«ã€‚", prompt, true);
        const model = getGeminiModel(true);
        const res = await model.generateContent(prompt);
        return cleanJson(res.response.text());
    } catch (e) {
        return null;
    }
};

export const ensureInfiniteSettings = async (simpleSettings, tags = [], tone = "ä¸€èˆ¬", category = "BG", useDeepSeek = false) => {
    const toneDesc = getToneInstruction(tone);

    // å¦‚æœå·²ç¶“æœ‰è©³ç´°ä¸–ç•Œè§€ï¼Œå‰‡è·³é
    if (simpleSettings.design_blueprint && simpleSettings.protagonist?.profile) {
        return simpleSettings;
    }

    const prompt = `
    ä½ æ˜¯ä¸€ä½ç„¡é™æµå°èªªæ¶æ§‹å¸«ã€‚
    è«‹æ ¹æ“šç¾æœ‰çš„ç°¡å–®è¨­å®šï¼Œè£œå…¨ã€ä¸–ç•Œè§€è—åœ–ã€‘èˆ‡ã€è§’è‰²è©³æƒ…ã€‘ã€‚
    (æ³¨æ„ï¼šæš«æ™‚ä¸éœ€è¦è¨­è¨ˆå‰¯æœ¬ï¼Œè«‹å°ˆæ³¨æ–¼ä¸»ä¸–ç•Œèˆ‡äººç‰©)
    
    æ¨™é¡Œï¼š${simpleSettings.title}
    é¢¨æ ¼ï¼š${tags.join('ã€')}
    ${INFINITE_ANTI_CLICHE}

    ã€è£œå…¨ä»»å‹™ã€‘
    1. **ä¸–ç•Œè§€è—åœ– (Design Blueprint)**ï¼šè«‹è¨­è¨ˆä¸»è§’çš„ã€Œçµ‚æ¥µç›®æ¨™ã€ã€ç„¡é™ä¸–ç•Œçš„ã€Œéš±è—çœŸç›¸ã€ä»¥åŠã€Œé è¨­çµå±€ã€ã€‚
    2. **è§’è‰²æ·±åº¦è¨­å®š**ï¼šè«‹å®Œå–„ä¸»è§’ (${simpleSettings.protagonist?.name || simpleSettings.protagonist}) èˆ‡å°è±¡ (${simpleSettings.loveInterest?.name || simpleSettings.loveInterest}) çš„è©³ç´°äººè¨­ï¼ˆå¤–è²Œã€æ€§æ ¼ã€èªªè©±é¢¨æ ¼ï¼‰ã€‚
    3. **é…è§’è¨­è¨ˆ**ï¼šè£œå…… 2 ä½é—œéµéšŠå‹ã€‚

    å›å‚³ JSON (åªå›å‚³éœ€è¦è£œå…¨/æ›´æ–°çš„æ¬„ä½):
    {
        "design_blueprint": { 
            "main_goal": "...", 
            "world_truth": "...", 
            "ending_vision": "...",
            "side_characters": [ { "name": "...", "role": "...", "profile": "..." } ]
        },
        "protagonist": { 
            "name": "${simpleSettings.protagonist?.name || simpleSettings.protagonist}", 
            "role": "ä¸»è§’", 
            "profile": { "appearance": "...", "personality_surface": "...", "personality_core": "...", "biography": "...", "speaking_style": "...", "sample_dialogue": "..." } 
        },
        "loveInterest": { 
            "name": "${simpleSettings.loveInterest?.name || simpleSettings.loveInterest}", 
            "role": "å°è±¡", 
            "profile": { "appearance": "...", "personality_surface": "...", "personality_core": "...", "biography": "...", "speaking_style": "...", "sample_dialogue": "..." } 
        },
        "relationships": [
            { "source": "${simpleSettings.protagonist?.name || 'ä¸»è§’'}", "target": "${simpleSettings.loveInterest?.name || 'å°è±¡'}", "type": "å®¿æ•µ/å‰ä»»/é™Œç”Ÿäºº", "status": "Not Met", "description": "åˆå§‹é—œä¿‚æè¿°" }
        ]
    }
    `;

    try {
        let result;
        if (useDeepSeek) result = await callDeepSeek("ä½ æ˜¯ä¸€ä½ç„¡é™æµæ¶æ§‹å¸«ã€‚", prompt, true);
        else {
            const model = getGeminiModel(true);
            const res = await model.generateContent(prompt);
            result = cleanJson(res.response.text());
        }

        const finalSettings = { ...simpleSettings, ...(result || {}) };

        if (!finalSettings.protagonist || typeof finalSettings.protagonist === 'string') {
            finalSettings.protagonist = {
                name: typeof finalSettings.protagonist === 'string' ? finalSettings.protagonist : "ä¸»è§’",
                role: 'ä¸»è§’',
                profile: {}
            };
        }
        if (!finalSettings.loveInterest || typeof finalSettings.loveInterest === 'string') {
            finalSettings.loveInterest = {
                name: typeof finalSettings.loveInterest === 'string' ? finalSettings.loveInterest : "å°è±¡",
                role: 'å°è±¡',
                profile: {}
            };
        }

        if (!finalSettings.design_blueprint || Object.keys(finalSettings.design_blueprint).length === 0) {
            console.log("âš ï¸ design_blueprint missing, generating fallback...");
            const blueprintPrompt = `
            è«‹ç‚ºç„¡é™æµå°èªªã€Š${finalSettings.title}ã€‹è¨­è¨ˆã€ä¸–ç•Œè§€è—åœ–ã€‘ã€‚
            é¢¨æ ¼ï¼š${tags.join('ã€')}
            ä¸»è§’ï¼š${finalSettings.protagonist.name}
            å°è±¡ï¼š${finalSettings.loveInterest.name}
            
            å›å‚³ JSON:
            {
                "design_blueprint": { 
                    "main_goal": "ä¸»è§’çš„çµ‚æ¥µç›®æ¨™", 
                    "world_truth": "ç„¡é™ä¸–ç•Œçš„éš±è—çœŸç›¸", 
                    "ending_vision": "é è¨­çµå±€",
                    "side_characters": [ { "name": "é…è§’å", "role": "å®šä½", "profile": "ç°¡ä»‹" } ]
                }
            }
            `;
            try {
                let bpResult;
                if (useDeepSeek) bpResult = await callDeepSeek("ä½ æ˜¯ä¸€ä½ç„¡é™æµæ¶æ§‹å¸«ã€‚", blueprintPrompt, true);
                else {
                    const model = getGeminiModel(true);
                    const res = await model.generateContent(blueprintPrompt);
                    bpResult = cleanJson(res.response.text());
                }
                if (bpResult && bpResult.design_blueprint) {
                    finalSettings.design_blueprint = bpResult.design_blueprint;
                }
            } catch (err) {
                console.warn("Blueprint fallback failed:", err);
                finalSettings.design_blueprint = { main_goal: "æ´»ä¸‹å»", world_truth: "æœªçŸ¥", ending_vision: "æœªçŸ¥" };
            }
        }

        return finalSettings;

    } catch (e) {
        console.error("ensureInfiniteSettings failed:", e);
        const fallback = { ...simpleSettings };
        if (!fallback.protagonist || typeof fallback.protagonist === 'string') {
            fallback.protagonist = { name: typeof fallback.protagonist === 'string' ? fallback.protagonist : "ä¸»è§’", role: 'ä¸»è§’', profile: {} };
        }
        if (!fallback.loveInterest || typeof fallback.loveInterest === 'string') {
            fallback.loveInterest = { name: typeof fallback.loveInterest === 'string' ? fallback.loveInterest : "å°è±¡", role: 'å°è±¡', profile: {} };
        }
        return fallback;
    }
};

// ==========================================
// ==========================================
// 2. ç¬¬ä¸€ç« ç”Ÿæˆ (The Pilot Director)
// ==========================================
export const generateInfiniteStart = async (settings, tags = [], tone = "ä¸€èˆ¬", pov = "å¥³ä¸»", useDeepSeek = false) => {
    const toneDesc = getToneInstruction(tone);
    const povDesc = getPovInstruction(pov);
    const styleGuide = `é¢¨æ ¼ï¼š${tags.join('ã€')} | ${toneDesc} | ${povDesc}`;

    const dynamicPrompt = getDynamicSettingPrompt(settings);

    // å…¥å±€é‚è¼¯ï¼šé˜²æ­¢æ–·ç‰‡
    const ENTRY_INSTRUCTION = `
    ã€âš ï¸ é–‹ç¯‡é—œéµï¼šæ‹’çµ•æ–·ç‰‡ (Entry Continuity)ã€‘
    è«‹å†æ¬¡é–±è®€ç°¡ä»‹ï¼š${settings.summary}
    1. **å…¥å±€**ï¼šå¿…é ˆå¾ç°¡ä»‹ä¸­çš„ã€Œå…¥å±€åŸå› ã€ï¼ˆå¦‚è»Šç¦ã€ç°½ç´„ã€ç›®æ“Šï¼‰åˆ‡å…¥ï¼Œä¸è¦å¯«ã€Œä¸€è¦ºé†’ä¾†å¤±æ†¶ã€ã€‚
    2. **éæ¸¡**ï¼šæå¯«ç¾å¯¦ä¸–ç•Œæ˜¯å¦‚ä½•æ‰­æ›²æˆç•°ä¸–ç•Œçš„ï¼ˆå¦‚ï¼šèµ°å»Šç„¡é™å»¶ä¼¸ã€æ‰‹æ©Ÿè®Šæˆè¡€ç´…è‰²ï¼‰ã€‚
    3. **åˆæ¢**ï¼šä¸»è§’æŠµé”ä¸»ä¸–ç•Œï¼ˆéå‰¯æœ¬ï¼‰ï¼Œæ„Ÿå—åˆ°é€™å€‹ç¤¾æœƒçš„æƒ¡æ„èˆ‡è¦å‰‡ã€‚
    `;

    const prompt = `
    ä½ æ˜¯ä¸€ä½ç„¡é™æµå°èªªå®¶ã€‚è«‹æ’°å¯«**ç¬¬ä¸€ç« **ã€‚
    ${styleGuide}
    ${INFINITE_STYLE_GUIDE}
    ${dynamicPrompt}
    ${ENTRY_INSTRUCTION}

    ã€å°èªªè¨­å®šã€‘
    - æ¨™é¡Œï¼š${settings.title}
    - ç°¡ä»‹ï¼š${settings.summary}
    - ä¸»ä¸–ç•Œï¼š${JSON.stringify(settings.main_world_setting)}
    - ä¸»è§’ï¼š${JSON.stringify(settings.protagonist)}
    - å°è±¡ï¼š${JSON.stringify(settings.loveInterest)}

    ã€å¯«ä½œä»»å‹™ã€‘
    1. å¯«å‡ºä¸€å€‹ä»¤äººæ¯›éª¨æ‚šç„¶çš„é–‹é ­ã€‚
    2. è®“ä¸»è§’è¿…é€Ÿæ„è­˜åˆ°è™•å¢ƒï¼Œä¸¦å±•ç¾å‡ºä¸åŒæ–¼å¸¸äººçš„åæ‡‰ï¼ˆé‡‘æ‰‹æŒ‡/æ€§æ ¼ï¼‰ã€‚
    3. **çµå°¾æ‡¸å¿µ**ï¼šåœåœ¨ä¸€å€‹è¡çªå³å°‡çˆ†ç™¼ï¼Œæˆ–è€…ç™¼ç¾é©šäººçœŸç›¸çš„ç¬é–“ã€‚
    4. å­—æ•¸ï¼š2000+ã€‚

    ã€å›å‚³ JSONã€‘
    {
      "content": "...",
      "plot_state": {
          "phase": "hub", 
          "sub_phase": "intro",
          "hub_tension": 20, // ç¬¬ä¸€ç« é€šå¸¸æœƒç©ç´¯ä¸€é»å¼µåŠ›
          "cycle_num": 0,
          "current_dungeon": null
      },
      "cliffhanger_note": "ç¬¬ä¸€ç« çµå°¾åœåœ¨ä¸»è§’çœ‹åˆ°äº†ç‰†ä¸Šçš„è¡€å­—è¦å‰‡ï¼Œä¸¦ä¸”èº«å¾Œå‚³ä¾†äº†è…³æ­¥è²ã€‚" 
    }
    `;

    try {
        let result;
        if (useDeepSeek) result = await callDeepSeek("ä½ æ˜¯ç„¡é™æµå°èªªå®¶ã€‚", prompt, true);
        else {
            const model = getGeminiModel(true);
            const res = await model.generateContent(prompt);
            result = cleanJson(res.response.text());
        }

        // ç¢ºä¿ç¬¬ä¸€ç« ç”Ÿæˆçš„å‰¯æœ¬è¨­å®šï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰è¢«ä¿å­˜
        if (settings.first_dungeon_setting) {
            result.plot_state.preloaded_dungeon = settings.first_dungeon_setting;
        }
        return result;
    } catch (e) { throw new Error("ç”Ÿæˆå¤±æ•—"); }
};

export const generateDungeonDesign = async (arcName, tone, tags = [], cycleNum, extraInstruction = "", hazards = [], useDeepSeek = false) => {
    const isRuleBased = tags.includes("è¦å‰‡æ€ªè«‡");
    const hazardsText = hazards.length > 0 ? `\nç’°å¢ƒå±å®³ï¼š${hazards.join('ã€')}` : "";
    const designType = isRuleBased ? "è¦å‰‡æ€ªè«‡" : "ä¸€èˆ¬ç„¡é™æµ";
    const mechanicReq = isRuleBased ? "è«‹è¨­è¨ˆ 5-8 æ¢ç´…è—å­—è¦å‰‡ï¼ŒåŒ…å«çŸ›ç›¾èˆ‡èªçŸ¥æ±¡æŸ“ã€‚" : "è«‹è¨­è¨ˆæ˜ç¢ºçš„ã€Œä¸»ç·šä»»å‹™ã€ã€ã€Œæ”¯ç·šä»»å‹™ã€ã€ã€Œé™åˆ¶æ¢ä»¶ã€èˆ‡ã€Œå¤±æ•—æ‡²ç½°ã€ã€‚";

    const prompt = `
    ä½ æ˜¯ä¸€ä½ç„¡é™æµå‰¯æœ¬è¨­è¨ˆå¸«ã€‚
    è«‹ç‚ºç¬¬ ${cycleNum} å€‹å‰¯æœ¬ã€${arcName}ã€‘è¨­è¨ˆè¨­å®šã€‚
    é¡å‹ï¼š${designType}ã€‚åŸºèª¿ï¼š${tone}ã€‚
    ${hazardsText} ${extraInstruction}
    ã€è¨­è¨ˆè¦æ±‚ã€‘
    1. **ä¸–ç•Œè§€**ï¼šè©­ç•°çš„èƒŒæ™¯æ•…äº‹ã€‚
    2. **æ ¸å¿ƒæ©Ÿåˆ¶**ï¼š${mechanicReq}
    3. **ç‰¹æ®Šæ©Ÿåˆ¶**ï¼šè€ƒé©—äººæ€§çš„æ©Ÿåˆ¶ã€‚
    4. **é«˜å…‰æ™‚åˆ»**ï¼šé è¨­é©åˆä¸åŒå°ˆé•·éšŠå‹ç™¼æ®çš„ç’°ç¯€ã€‚
    5. **çµå±€**ï¼šæ™®é€š/å®Œç¾é€šé—œæ¢ä»¶ã€‚
    ã€å›å‚³ JSONã€‘
    {
        "dungeon_name": "å‰¯æœ¬åç¨±", "difficulty": "ç­‰ç´š", "background_story": "...",
        "core_rules": ${isRuleBased ? '["è¦å‰‡1..."]' : '[]'},
        "missions": ${isRuleBased ? '[]' : '["ä¸»ç·šä»»å‹™..."]'},
        "mechanics": { "gameplay_focus": "...", "environment": "...", "relationship_test": "...", "role_highlights": "..." },
        "entities": [ { "name": "...", "description": "...", "weakness": "..." } ],
        "endings": { "normal": "...", "true": "..." }
    }
    `;

    try {
        if (useDeepSeek) return await callDeepSeek("ä½ æ˜¯ä¸€ä½ç„¡é™æµå‰¯æœ¬æ¶æ§‹å¸«ã€‚", prompt, true);
        const model = getGeminiModel(true);
        const res = await model.generateContent(prompt);
        return cleanJson(res.response.text());
    } catch (e) {
        const model = getGeminiModel(true);
        const res = await model.generateContent(prompt);
        return cleanJson(res.response.text());
    }
};

// ==========================================
// ğŸ¬ Infinite Flow Director (ç„¡é™æµå°æ¼” - äº‹ä»¶é©…å‹•ç‰ˆ)
// ==========================================
export const directorInfinite = (currentChapterIndex, lastPlotState, totalChapters) => {
    // 1. åˆå§‹åŒ–ç‹€æ…‹è®€å–
    // å¦‚æœæ˜¯ç¬¬ä¸€ç« ï¼Œé è¨­ç‚º "hub_intro"
    let phase = lastPlotState?.phase || "hub_intro";
    let subPhase = lastPlotState?.sub_phase || "normal";
    let hubTension = lastPlotState?.hub_tension || 0; // ä¸»ä¸–ç•Œå¼µåŠ›å€¼ (0-100)
    let cycleNum = lastPlotState?.cycle_num || 0;     // å·²åº¦éçš„å‰¯æœ¬æ•¸
    let instanceProgress = lastPlotState?.instance_progress || 0;
    let arcName = lastPlotState?.arcName || "åºç« ï¼šåˆå…¥ä¸–ç•Œ";

    // åˆ¤æ–·æ˜¯å¦æ¥è¿‘çµå±€
    const isFinale = (totalChapters - currentChapterIndex) <= 5;
    if (isFinale) {
        return {
            phase: 'finale',
            sub_phase: 'final_battle',
            intensity: 'high',
            directive: "ã€çµ‚å±€æ¨¡å¼ã€‘å…¨æ›¸é«˜æ½®ã€‚æ­é–‹ç„¡é™ä¸–ç•Œçš„çµ‚æ¥µçœŸç›¸ï¼Œä¸»è§’æŒ‘æˆ°ç³»çµ±/ä¸»ç¥/æ ¡é•·ï¼Œæ‰“ç ´è¼ªè¿´ã€‚",
            arcName: "çµ‚ç« ï¼šä¸–ç•Œå´©å¡Œ",
            hubTension: 100,
            cycleNum,
            instanceProgress
        };
    }

    // è®Šæ•¸æº–å‚™
    let directive = "";
    let intensity = "medium";
    let nextPhase = phase;
    let nextSubPhase = subPhase;
    let nextHubTension = hubTension;
    let nextCycleNum = cycleNum;
    let nextInstanceProgress = instanceProgress;

    // =====================================================
    // ğŸ« BRANCH A: ä¸»ä¸–ç•ŒåŠ‡æƒ…ç·š (The Hub Story)
    // =====================================================
    if (phase.startsWith("hub")) {
        // é‡ç½®å‰¯æœ¬é€²åº¦
        nextInstanceProgress = 0;

        // --- A1. å‰›é€²å…¥ä¸»ä¸–ç•Œ (Intro) ---
        if (phase === "hub_intro") {
            intensity = "high (suspense)";
            directive = `ã€éšæ®µï¼šæ–°äººå ±åˆ°/ä¸–ç•Œè§€å°å…¥ã€‘
            - **å ´æ™¯**ï¼šä¸»è§’åˆæ¬¡æŠµé”ä¸»ä¸–ç•Œï¼ˆå­¸æ ¡/å…¬å¯“/åˆ—è»Šï¼‰ã€‚
            - **æ ¸å¿ƒè¡çª**ï¼šå°é™Œç”Ÿè¦å‰‡çš„ä¸é©æ‡‰ï¼Œä»¥åŠã€Œè³‡æ·±è€…/NPCã€çš„ä¸‹é¦¬å¨ã€‚
            - **é¢¨æ ¼**ï¼šå¼·èª¿ã€Œè’èª•æ„Ÿã€èˆ‡ã€Œè¦å‰‡çš„è‡´å‘½æ€§ã€ã€‚
            - **çµå°¾**ï¼šä¸è¦é€²å‰¯æœ¬ï¼çµå°¾åœåœ¨ä¸»è§’ç™¼ç¾é€™å€‹ä¸–ç•Œã€Œè²¨å¹£/å­¸åˆ†ã€çš„é‡è¦æ€§ã€‚`;

            // ä¸‹ä¸€æ­¥ï¼šé€²å…¥ä¸»ä¸–ç•Œæ—¥å¸¸ (æ‹‰é•·ä¼‘æ•´æœŸ)
            nextPhase = "hub_story";
            nextSubPhase = "normal_settling_in"; // æ–°å¢ç·©è¡éšæ®µ
            nextHubTension = 5; // é™ä½åˆå§‹å¼µåŠ›
        }

        // --- A2. å‰¯æœ¬å›æ­¸çµç®— (Return) ---
        else if (phase === "hub_return") {
            intensity = "low";
            directive = `ã€éšæ®µï¼šå‰¯æœ¬çµç®—èˆ‡ç™¼é…µã€‘
            - **å ´æ™¯**ï¼šå‰›å¾æ­»äº¡é‚Šç·£å›ä¾†ï¼Œå…¨æ ¡/å…¨å€é€šå ±æˆç¸¾ã€‚
            - **çˆ½é»**ï¼šä¸»è§’å› ç‚ºåœ¨å‰¯æœ¬è£¡çš„é¨·æ“ä½œè€Œç²å¾—é«˜è©•åƒ¹/é«˜çå‹µï¼Œéœ‡é©šè·¯äººã€‚
            - **ä¼‘æ†©**ï¼šå¿…é ˆæå¯«ä¸»è§’**å›åˆ°å®‰å…¨å€çš„æ”¾é¬†æ„Ÿ**ã€‚æ´—ç†±æ°´æ¾¡ã€åƒé “å¥½çš„ã€ç¡å€‹å¥½è¦ºã€‚é€™èˆ‡å‰¯æœ¬çš„ç·Šå¼µå½¢æˆå°æ¯” (èµ·æ‰¿è½‰åˆ-åˆ)ã€‚
            - **ä¼ç­†**ï¼šç²å¾—é—œæ–¼ä¸»ä¸–ç•ŒçœŸç›¸çš„ç¢ç‰‡ç·šç´¢ã€‚`;

            // ä¸‹ä¸€æ­¥ï¼šé€²å…¥ä¸»ä¸–ç•Œæ—¥å¸¸
            nextPhase = "hub_story";
            nextSubPhase = "normal_rest"; // å¼·åˆ¶ä¼‘æ¯éšæ®µ
            nextHubTension = 10;
        }

        // --- A3. ä¸»ä¸–ç•ŒåŠ‡æƒ…å¼•æ“ (Core Engine) ---
        else if (phase === "hub_story") {

            // [è§¸ç™¼åˆ¤æ–·]ï¼šå¦‚æœå¼µåŠ›çˆ†è¡¨ï¼Œå¼·åˆ¶é€²å…¥å‰¯æœ¬
            // [è§¸ç™¼åˆ¤æ–·]ï¼šå¦‚æœå¼µåŠ›çˆ†è¡¨ï¼Œå¼·åˆ¶é€²å…¥å‰¯æœ¬
            if (hubTension >= 80) {
                return {
                    phase: "dungeon_entry",
                    directive: `ã€è½‰æŠ˜é»ï¼šå…¥å±€ã€‘ä¸»ä¸–ç•ŒåŠ‡æƒ…å¼µåŠ›å·²é”è‡¨ç•Œé»ã€‚è«‹æ ¹æ“š**ä¸Šä¸€ç« çš„åŠ‡æƒ…ç™¼å±•**ï¼ˆæ˜¯ä»‡å®¶è¿½æ®ºï¼Ÿæ¬ å‚µï¼Ÿé‚„æ˜¯ç³»çµ±å¼·åˆ¶ï¼Ÿï¼‰ï¼Œè¨­è¨ˆä¸€å€‹æœ€ç¬¦åˆé‚è¼¯çš„ã€Œå…¥å±€ç†ç”±ã€ï¼Œä¸¦æå¯«ä¸»è§’è¢«å¸å…¥/å‚³é€é€²å‰¯æœ¬çš„éç¨‹ã€‚`,
                    hubTension: 0,
                    cycleNum: cycleNum + 1,
                    instanceProgress: 0
                };
            }

            // [å­éšæ®µæ¼”ç¹¹]ï¼šå¢åŠ ä¼‘æ•´èˆ‡æ—¥å¸¸çš„ç¯‡å¹…
            if (subPhase === "normal_settling_in" || subPhase === "normal_rest") {
                intensity = "low";
                directive = `ã€ä¸»ä¸–ç•Œï¼šæ—¥å¸¸èˆ‡æ•´å‚™ã€‘
                - **é‡é»**ï¼šæå¯«ä¸»è§’å¦‚ä½•åˆ©ç”¨ä¸Šå€‹å‰¯æœ¬çš„çå‹µå¼·åŒ–è‡ªå·±ï¼ˆè³¼è²·é“å…·ã€é›éŠæŠ€èƒ½ï¼‰ã€‚
                - **äººéš›**ï¼šèˆ‡éšŠå‹/CP åœ¨éæˆ°é¬¥ç‹€æ…‹ä¸‹çš„ç›¸è™•ï¼ˆä¸€èµ·åƒé£¯ã€é€›è¡—ã€äº¤æ›æƒ…å ±ï¼‰ã€‚
                - **æ°›åœ**ï¼šæš«æ™‚çš„å¯§éœï¼Œä½†éš±ç´„èƒ½æ„Ÿè¦ºåˆ°ä¸»ä¸–ç•Œçš„é•å’Œæ„Ÿã€‚`;

                nextSubPhase = "normal_conflict";
                nextHubTension += 10;
            }
            else if (subPhase === "normal_conflict" || subPhase === "normal") {
                intensity = "low (comedy/drama)";
                directive = `ã€ä¸»ä¸–ç•Œï¼šè’èª•æ—¥å¸¸ã€‘
                - **ç¦æ­¢å¯«å‰¯æœ¬ï¼** è«‹æå¯«é€™å€‹è©­ç•°ä¸–ç•Œçš„æ—¥å¸¸ç”Ÿæ´»ï¼ˆå¦‚ï¼šç”¨çœ¼çƒåšèœçš„é£Ÿå ‚ã€æœƒå’¬äººçš„è²©è³£æ©Ÿï¼‰ã€‚
                - **äº‹ä»¶**ï¼šä¸»è§’è©¦åœ–ç”¨ã€Œç¾å¯¦ä¸–ç•Œçš„é‚è¼¯ã€å»è§£æ§‹é€™è£¡çš„è©­ç•°è¦å‰‡ï¼Œç”¢ç”Ÿå†·å¹½é»˜æ•ˆæœã€‚
                - **å¾®è¡çª**ï¼šé‡åˆ°ä¸€äº›ä¸é•·çœ¼çš„å°åæ´¾ï¼ˆéœ¸å‡Œè€…/å¥¸å•†ï¼‰ï¼Œè¼•é¬†è§£æ±ºï¼Œä½†åŸ‹ä¸‹ç¦æ ¹ã€‚`;

                // æ¨æ¼”ï¼šæ—¥å¸¸ -> è¡çª
                nextSubPhase = "conflict_escalation";
                nextHubTension += 15;
            }
            else if (subPhase === "conflict_escalation" || subPhase === "conflict") {
                intensity = "medium";
                directive = `ã€ä¸»ä¸–ç•Œï¼šè¡çªå‡ç´šã€‘
                - **äº‹ä»¶**ï¼šä¸»ä¸–ç•Œçš„å‹¢åŠ›ï¼ˆå­¸ç”Ÿæœƒ/æƒ¡éœ¸/åŸ·æ³•éšŠ/è²ªå©ªNPCï¼‰æ‰¾ä¸»è§’éº»ç…©ã€‚
                - **åæ“Š**ï¼šä¸»è§’åˆ©ç”¨è¦å‰‡æ¼æ´ç‹ ç‹ æ‰“è‡‰ï¼Œé›–ç„¶è´äº†ï¼Œä½†å¾¹åº•å¾—ç½ªäº†å°æ–¹ã€‚
                - **æ°›åœ**ï¼šå±±é›¨æ¬²ä¾†é¢¨æ»¿æ¨“ã€‚`;

                // æ¨æ¼”ï¼šè¡çª -> å±æ©Ÿ
                nextSubPhase = "climax";
                nextHubTension += 25;
            }
            else if (subPhase === "climax") {
                intensity = "high";
                directive = `ã€ä¸»ä¸–ç•Œï¼šå±æ©Ÿçˆ†ç™¼ã€‘
                - **äº‹ä»¶**ï¼šåæ´¾å‹•ç”¨æ¬Šé™å°æ®ºä¸»è§’ï¼ˆå¦‚ï¼šæ–·æ°´æ–·é›»ã€åˆ—å…¥æ­»äº¡åå–®ï¼‰ã€‚
                - **æ±ºç­–**ï¼šç‚ºäº†ç”Ÿå­˜æˆ–åæ®ºï¼Œä¸»è§’æ±ºå®š**ä¸»å‹•**å»æŒ‘æˆ°æŸå€‹å‚³èªªä¸­çš„ã€Œæ­»äº¡å‰¯æœ¬ã€ï¼ˆç½®ä¹‹æ­»åœ°è€Œå¾Œç”Ÿï¼‰ã€‚
                - **çµå°¾**ï¼šåœåœ¨é€²å…¥å‰¯æœ¬å‚³é€é–€çš„å‰ä¸€åˆ»ã€‚`;

                // æ¨æ¼”ï¼šå±æ©Ÿ -> æ»¿å¼µåŠ› (ä¸‹ä¸€ç« é€²å‰¯æœ¬)
                nextHubTension = 100;
            }
        }
    }

    // =====================================================
    // ğŸ—¡ï¸ BRANCH B: å‰¯æœ¬æ”»ç•¥ç·š (The Dungeon Run)
    // =====================================================
    else {
        // è‡ªç„¶å¢é•·é€²åº¦ (å¦‚æœ planner æ²’çµ¦å…·é«”æ•¸å€¼)
        nextInstanceProgress = Math.min(instanceProgress + 10, 100);

        // å‰¯æœ¬éšæ®µåŠƒåˆ†
        if (nextInstanceProgress <= 15) {
            nextPhase = "setup"; // èµ·
            intensity = "high (horror)";
            directive = `ã€å‰¯æœ¬éšæ®µï¼šé–‹å±€æ®º/è¦å‰‡å°å…¥ (èµ·)ã€‘
            - **å ´æ™¯**ï¼šé™Œç”Ÿçš„ææ€–ç’°å¢ƒã€‚
            - **é‡é»**ï¼šå±•ç¤ºå‰¯æœ¬çš„ã€Œè‡´æ­»è¦å‰‡ã€ã€‚è®“ä¸€å€‹ç‚®ç°è§¸ç™¼è¦å‰‡æ­»äº¡ï¼Œä»¥æ­¤è­¦ç¤ºä¸»è§’ã€‚
            - **åæ‡‰**ï¼šä¸»è§’å†·éœåˆ†æï¼ˆæˆ–å«Œæ£„é¬¼æ€ªå¤ªé†œï¼‰ï¼Œå±•ç¾é«˜æ™ºå•†/å¼·å¿ƒç†ç´ è³ªã€‚`;
        }
        else if (nextInstanceProgress <= 55) {
            nextPhase = "investigation"; // æ‰¿
            intensity = "medium";
            directive = `ã€å‰¯æœ¬éšæ®µï¼šæ¢ç´¢èˆ‡è§£è¬ (æ‰¿)ã€‘
            - **ç©æ³•**ï¼šåˆ©ç”¨è¦å‰‡æ¼æ´ï¼Œæˆ–ç™¼ç¾é¬¼æ€ªçš„ç”Ÿå‰åŸ·å¿µã€‚
            - **CPé«˜å…‰**ï¼šå…©äººåœ¨å±éšªä¸­äº’ç›¸äº¤ä»˜å¾ŒèƒŒã€‚
            - **åŠ‡æƒ…**ï¼šä¸è¦åªæ˜¯æ‰“æ€ªï¼Œè¦æ­éœ²å‰¯æœ¬èƒŒå¾Œçš„æ‚²åŠ‡æ•…äº‹ã€‚`;
        }
        else if (nextInstanceProgress <= 80) {
            nextPhase = "twist"; // è½‰
            intensity = "high (suspense)";
            directive = `ã€å‰¯æœ¬éšæ®µï¼šåè½‰èˆ‡å±æ©Ÿ (è½‰)ã€‘
            - **è½‰æŠ˜**ï¼šåŸæœ¬ä»¥ç‚ºçš„é€šé—œè¦å‰‡æ˜¯å‡çš„/é™·é˜±ï¼æˆ–è€…BOSSé€²å…¥äº†ç¬¬äºŒéšæ®µã€‚
            - **å›°å¢ƒ**ï¼šä¸»è§’åœ˜é™·å…¥çµ•å¢ƒï¼ŒåŸæœ¬çš„è¨ˆç•«å¤±æ•ˆã€‚
            - **çˆ†é»**ï¼šæ­éœ²å‰¯æœ¬æœ€æ·±å±¤çš„æ®˜é…·çœŸç›¸ï¼ˆTrope Revealï¼‰ã€‚`;
        }
        else if (nextInstanceProgress < 95) {
            nextPhase = "climax"; // åˆ (é«˜æ½®)
            intensity = "high";
            directive = `ã€å‰¯æœ¬éšæ®µï¼šæœ€çµ‚æ±ºæˆ°/ç ´å±€ (åˆ)ã€‘
            - **é«˜æ½®**ï¼šBOSS ç‹‚æš´æˆ–è¦å‰‡å…¨é¢å´©å¡Œã€‚
            - **åè½‰**ï¼šä¸»è§’æ­é–‹å‰¯æœ¬çœŸç›¸ï¼Œå®Œæˆã€Œå®Œç¾é€šé—œã€çš„é—œéµæ“ä½œã€‚
            - **å¼µåŠ›**ï¼šCP ç‚ºäº†ä¿è­·å°æ–¹å—å‚·ï¼Œæˆ–å±•ç¾å‡ºç˜‹æ‰¹çš„ä¸€é¢ã€‚`;
        }
        else {
            nextPhase = "resolution";
            intensity = "low";
            directive = `ã€å‰¯æœ¬éšæ®µï¼šçµç®—é›¢é–‹ã€‘
            - **çµå±€**ï¼šçœ‹è‘—å‰¯æœ¬å´©å¡Œæˆ–BOSSè§£è„«ã€‚
            - **æ”¶ç©«**ï¼šç²å¾—é—œéµé“å…·æˆ–å¤§é‡ç©åˆ†ã€‚
            - **çµå°¾**ï¼šå‚³é€å…‰èŠ’äº®èµ·ï¼Œæº–å‚™å›åˆ°ä¸»ä¸–ç•Œæ‰“è‡‰é‚£äº›ç­‰è‘—çœ‹ç¬‘è©±çš„äººã€‚`;

            // âš ï¸ é—œéµï¼šå‰¯æœ¬çµæŸå¾Œï¼Œå¼·åˆ¶æŠŠä¸‹ä¸€ç« çš„ç‹€æ…‹æ”¹å› "hub_return"
            // é€™è£¡æˆ‘å€‘åªæ¨™è¨˜ "resolution"ï¼ŒçœŸæ­£çš„ç‹€æ…‹åˆ‡æ›äº¤çµ¦ä¸‹ä¸€æ¬¡ director åŸ·è¡Œ
            // æˆ–è€…æˆ‘å€‘å¯ä»¥åœ¨ planInfinite è£¡è™•ç†é€™å€‹åˆ‡æ›ï¼Œé€™è£¡ç‚ºäº†ä¿éšªï¼Œæˆ‘å€‘å›å‚³ä¸€å€‹æ¨™è¨˜
        }
    }

    // å¦‚æœæœ¬ç« æ˜¯å‰¯æœ¬çµç®— (Resolution)ï¼Œé åˆ¤ä¸‹ä¸€ç« å›åˆ°ä¸»ä¸–ç•Œ
    if (phase === "resolution") {
        return {
            phase: "hub_return", // å¼·åˆ¶åˆ‡æ›å›ä¸»ä¸–ç•Œ
            sub_phase: "normal",
            intensity: "low",
            directive: "ã€å›æ­¸ã€‘å‚³é€å›ä¸»ä¸–ç•Œï¼Œé¢å°çœ¾äººçš„éœ‡é©šã€‚",
            arcName: "ä¸»ä¸–ç•Œï¼šå‡±æ—‹",
            hubTension: 0,
            cycleNum: nextCycleNum,
            instanceProgress: 0
        };
    }

    return {
        phase: nextPhase,
        sub_phase: nextSubPhase,
        intensity: intensity,
        directive: directive,
        arcName: arcName,
        hubTension: nextHubTension,
        cycleNum: nextCycleNum,
        instanceProgress: nextInstanceProgress
    };
};

// ==========================================
// 5. ç„¡é™æµ Planner Agent (åˆ†æµé‚è¼¯)
// ==========================================
export const planInfinite = async ({
    director,
    blueprint,
    contextSummary,
    memories = [],
    clues = [],
    characters = [],
    tags = [],
    tone = "ä¸€èˆ¬",
    lastPlotState = null,
    useDeepSeek = false,
    novelId = null,
    novelContext = {}
}) => {
    const isRuleBased = tags.includes("è¦å‰‡æ€ªè«‡");

    // 1. ç‹€æ…‹åˆå§‹åŒ–
    let phase = director.phase;
    let subPhase = director.sub_phase;
    let cycleNum = director.cycleNum;
    let instanceProgress = director.instanceProgress;

    let currentDungeon = lastPlotState?.current_dungeon || null;
    let currentRules = lastPlotState?.current_rules || null;
    let usedThemes = lastPlotState?.used_themes || [];

    // ç²å–ç¬¬ä¸€ç« çš„æ‡¸å¿µç­†è¨˜
    const cliffhangerNote = lastPlotState?.cliffhanger_note || "ç„¡";
    // å‹•æ…‹è¨­å®šæç¤º
    const dynamicPrompt = getDynamicSettingPrompt(novelContext);

    // 2. ç‰¹æ®Šç‹€æ…‹è™•ç†
    let metaPlanningInstruction = "";
    const summary = novelContext.summary || "";
    const mainWorld = novelContext.settings?.main_world_setting || {};
    const relationships = novelContext.relationships || []; // ç²å–é—œä¿‚åœ–
    const combinedText = (summary + (mainWorld.type || "")).toLowerCase();

    if (combinedText.includes("ç›´æ’­") || combinedText.includes("ç¶œè—")) {
        metaPlanningInstruction = `
        ã€âš ï¸ ç‰¹æ®Šç­–åŠƒè¦æ±‚ï¼šç¶œè—ç›´æ’­æµã€‘
        é€™æ˜¯ä¸€å ´ç›´æ’­ç¶œè—ã€‚å¤§ç¶±ä¸­å¿…é ˆåŒ…å«ï¼š
        1. **äº’å‹•ç’°ç¯€**ï¼šè¨­è¨ˆè§€çœ¾/å½ˆå¹•çš„åæ‡‰ç¯€é»ï¼ˆå¦‚ï¼šä¸»è§’é‡åˆ°å±éšªæ™‚ï¼Œå½ˆå¹•åœ¨è³­å¥¹æ­»ï¼‰ã€‚
        2. **ç¯€ç›®æ•ˆæœ**ï¼šä¸»è§’æ˜¯å¦ç‚ºäº†äººæ°£/æ‰“è³è€Œæ•…æ„åšå‡ºé©šéšªå‹•ä½œï¼Ÿ
        3. **å ´å¤–å¹²é **ï¼šæ˜¯å¦æœ‰åœŸè±ªè§€çœ¾æ‰“è³äº†é—œéµé“å…·ï¼Ÿ
        `;
    }

    // (A) æ¸…ç©ºå‰¯æœ¬æ•¸æ“š
    if (phase === 'hub_return' || phase.startsWith('hub')) {
        currentDungeon = null;
        currentRules = null;
    }

    // (B) é è¨­å‰¯æœ¬
    if (phase === 'setup' && cycleNum === 1 && lastPlotState?.preloaded_dungeon && !currentDungeon) {
        currentDungeon = lastPlotState.preloaded_dungeon;
        director.arcName = currentDungeon.dungeon_name;
    }

    // (C) æœ‰æ©Ÿé€²åº¦èª¿æ•´
    if (!phase.startsWith('hub') && phase !== 'setup' && phase !== 'resolution') {
        const resolvedCluesCount = clues.filter(c => c.includes("å·²è§£æ±º") || c.includes("è§£é–‹")).length;
        const organicProgress = (Math.min(resolvedCluesCount / 5, 1) * 50);
        let newProgress = Math.max(instanceProgress, organicProgress);
        if (newProgress > 100) newProgress = 100;
        instanceProgress = newProgress;

        if (instanceProgress < 15) phase = "setup";
        else if (instanceProgress < 55) phase = "investigation";
        else if (instanceProgress < 80) phase = "twist";
        else if (instanceProgress < 95) phase = "climax";
        else phase = "resolution";
    }

    // 4. å‰¯æœ¬ç”Ÿæˆ
    const isNewDungeon = phase === 'setup' && !currentDungeon;

    if (phase === 'setup' && currentDungeon && !currentRules) {
        const rulesList = isRuleBased ? (currentDungeon.core_rules || []) : (currentDungeon.missions || ["ä»»å‹™ï¼šå­˜æ´»"]);
        currentRules = { title: isRuleBased ? "è¦å‰‡å®ˆå‰‡" : "ä»»å‹™é¢æ¿", rules: rulesList, hidden_truth: "å¾…æ¢ç´¢" };
        if (novelId) {
            try {
                await supabase.from('dungeons').insert({
                    novel_id: novelId, name: currentDungeon.dungeon_name, cycle_num: cycleNum, difficulty: currentDungeon.difficulty,
                    background_story: currentDungeon.background_story, mechanics: currentDungeon.mechanics, core_rules: rulesList,
                    rule_logic: currentRules, entities: currentDungeon.entities, endings: currentDungeon.endings, status: 'active'
                });
            } catch (err) { console.error("DB Save Error:", err); }
        }
    }

    if (isNewDungeon) {
        const randomTheme = selectDungeonTheme(tags, cycleNum, usedThemes);
        const dungeonName = `${director.arcName} - ${randomTheme}`;
        currentDungeon = await generateDungeonDesign(dungeonName, tone, tags, cycleNum, "", [], useDeepSeek);
        const rulesList = isRuleBased ? (currentDungeon.core_rules || []) : (currentDungeon.missions || ["ä»»å‹™ï¼šå­˜æ´»"]);
        currentRules = { title: isRuleBased ? "è¦å‰‡å®ˆå‰‡" : "ä»»å‹™é¢æ¿", rules: rulesList, hidden_truth: "å¾…æ¢ç´¢" };
        usedThemes.push(randomTheme);
        instanceProgress = 5;

        if (novelId) {
            try {
                await supabase.from('dungeons').insert({
                    novel_id: novelId, name: currentDungeon.dungeon_name, cycle_num: cycleNum, difficulty: currentDungeon.difficulty,
                    background_story: currentDungeon.background_story, mechanics: currentDungeon.mechanics, core_rules: rulesList,
                    rule_logic: currentRules, entities: currentDungeon.entities, endings: currentDungeon.endings, status: 'active'
                });
            } catch (err) { console.error("DB Save Error:", err); }
        }
    }

    const gameplayOps = (() => {
        if (phase === "setup") return isRuleBased ? "å±•ç¤ºã€è¦å‰‡å®ˆå‰‡ã€‘ï¼Œä½†é‡é»æ˜¯ä¸»è§’å€‘å°è¦å‰‡çš„åæ§½/ä¸å±‘/ææ…Œåæ‡‰ã€‚" : "ç™¼å¸ƒã€ä¸»ç·šä»»å‹™ã€‘ï¼Œé‡é»æå¯«ä¸»è§’åœ˜çš„ç£¨åˆèˆ‡åˆ†æ­§ã€‚";
        if (phase === "investigation") return "è§¸ç™¼ã€ç¾ˆçµ†è€ƒé©—ã€‘æˆ–ã€äººæ€§æŠ‰æ“‡ã€‘ã€‚åœ¨æ¢ç´¢ä¸­æ­éœ²éšŠå‹çš„éå»æˆ– CP çš„é»˜å¥‘ã€‚";
        if (phase === "twist") return "ã€åŠ‡æƒ…æ€¥è½‰ç›´ä¸‹ã€‘ç™¼ç¾åŸæœ¬çš„æ¨è«–æ˜¯éŒ¯çš„ï¼ç’°å¢ƒç™¼ç”ŸåŠ‡è®Šï¼Œæˆ–è€…éšŠå‹èƒŒå›/å¤±è¹¤ã€‚";
        if (phase === "climax") return "å…¨å“¡é«˜å…‰æ™‚åˆ»ã€‚åˆ©ç”¨åœ˜éšŠé…åˆæˆ– CP çš„çŠ§ç‰²/çˆ†ç™¼ä¾†ç ´å±€ï¼Œè€Œä¸æ˜¯å–®ç´”é æ•¸å€¼ç¢¾å£“ã€‚";
        if (phase === "rest" || phase.startsWith("hub")) return "ä¸»ä¸–ç•Œä¼‘æ•´ã€‚é‡é»åœ¨æ–¼ï¼šèŠ±éŒ¢/å¼·åŒ–ã€äººéš›äº¤æµã€æ—¥å¸¸æ”¾é¬†ã€‚ç¦æ­¢é«˜å¼·åº¦æˆ°é¬¥ã€‚";
        return "æ¨é€²åŠ‡æƒ…ï¼Œå¼·èª¿äººèˆ‡äººçš„äº’å‹•ã€‚";
    })();

    const dungeonContext = currentDungeon ? `ã€ğŸ¯ ç•¶å‰å‰¯æœ¬ï¼š${currentDungeon.dungeon_name}ã€‘\né›£åº¦ï¼š${currentDungeon.difficulty}\nèƒŒæ™¯ï¼š${currentDungeon.background_story}\næ ¸å¿ƒç©æ³•ï¼š${currentDungeon.mechanics?.gameplay_focus}\né€šé—œæ¢ä»¶ï¼š${currentDungeon.endings?.normal}` : "ã€ç•¶å‰å ´æ™¯ã€‘ä¸»ç¥ç©ºé–“/ç¾å¯¦ä¸–ç•Œ";
    const rulesContext = currentRules ? `ã€ğŸ“œ ${currentRules.title}ã€‘\n${currentRules.rules.join('\n')}` : "";

    const getMainWorldFlavor = (setting) => {
        if (!setting) return "æ™®é€šçš„ä¼‘æ¯å€äº’å‹•";
        const type = setting.type || "å…¶ä»–";
        const name = setting.name || "ä¸»ç¥ç©ºé–“";
        if (type.includes("ç›´æ’­")) return `ã€ä¸»ä¸–ç•Œï¼š${name}ã€‘ç›´æ’­å¾Œå°ï¼Œè™•ç†ç²‰çµ²è©•è«–ï¼Œæ’åç«¶çˆ­ã€‚`;
        if (type.includes("å…¬å¯“")) return `ã€ä¸»ä¸–ç•Œï¼š${name}ã€‘é„°é‡Œæ—¥å¸¸ï¼Œå™ªéŸ³æŠ•è¨´ï¼Œç¹³ç´å£½å‘½ç§Ÿé‡‘ã€‚`;
        if (type.includes("åˆ—è»Š")) return `ã€ä¸»ä¸–ç•Œï¼š${name}ã€‘å°é–‰æ—…é€”ï¼Œè»Šå»‚æƒ…å ±äº¤æ›ï¼Œä¹˜å‹™å“¡åˆé›£ã€‚`;
        return `ã€ä¸»ä¸–ç•Œï¼š${name}ã€‘æ®˜é…·é«”åˆ¶ï¼Œå…Œæ›å¼·åŒ–ï¼Œå‹¢åŠ›è¡çªã€‚`;
    };
    const mainWorldFlavor = getMainWorldFlavor(novelContext.main_world_setting);

    const getDungeonReason = (lastPlotState) => {
        if (lastPlotState?.hub_tension >= 100) return "ã€é€²å…¥åŸå› ï¼šè¢«è¿«/ç ´å±€ã€‘å› ç‚ºä¸»ä¸–ç•Œçš„çŸ›ç›¾ç„¡æ³•èª¿å’Œï¼Œä¸»è§’å¿…é ˆé€²å…¥å‰¯æœ¬å°‹æ±‚ç”Ÿæ©Ÿã€‚";
        return "ã€é€²å…¥åŸå› ï¼šå¸¸è¦è¼ªè¿´ã€‘ç³»çµ±çš„å¼·åˆ¶å¬å–šã€‚";
    };

    const prompt = `
    ä½ æ˜¯ä¸€ä½ç„¡é™æµå°èªªç­–åŠƒã€‚è«‹æ ¹æ“šä»¥ä¸‹è³‡è¨Šè¦åŠƒä¸‹ä¸€ç« å¤§ç¶±ã€‚
    ${INFINITE_ANTI_CLICHE}
    ${mainWorldFlavor}
    ${metaPlanningInstruction}
    ${dynamicPrompt}
    
    ã€âš ï¸ åš´æ ¼è¨­å®šä¸€è‡´æ€§ (Consistency Check)ã€‘
    1. **ç¦æ­¢æˆ°åŠ›å´©å£**ï¼šç›®å‰æ˜¯ç¬¬ ${cycleNum} å€‹å‰¯æœ¬ã€‚è«‹åš´æ ¼é™åˆ¶åŠ›é‡é«”ç³»ã€‚
       - å¦‚æœæ¨™ç±¤æ˜¯ã€Œç¾ä»£/æ ¡åœ’ã€ï¼Œ**åš´ç¦**å‡ºç¾é­”æ³•ã€ä¿®ä»™ã€é«˜ç§‘æŠ€æ­¦å™¨ã€‚
       - ä¸»è§’åªèƒ½ç”¨æ™ºæ…§ã€è¦å‰‡æ¼æ´æˆ–åŸºç¤é“å…·ç ´å±€ã€‚
    2. **ç¦æ­¢é¡å‹äº‚å…¥**ï¼šé™¤ç‰¹æ®Šæ¨™è¨»å¤–ï¼Œä¸è¦åœ¨è¥¿æ–¹èƒŒæ™¯å‡ºç¾æ±æ–¹é“å£«ï¼Œä¸è¦åœ¨éˆç•°èƒŒæ™¯å‡ºç¾å¤–æ˜Ÿäººã€‚
    3. **èµ·æ‰¿è½‰åˆ**ï¼šè«‹åš´æ ¼éµå®ˆç•¶å‰éšæ®µ (${phase}) çš„æ•˜äº‹åŠŸèƒ½ï¼Œä¸è¦æ¶æ‹ã€‚
    
    ã€ç•¶å‰ç‹€æ…‹ã€‘
    - éšæ®µï¼š${phase.toUpperCase()} (é€²åº¦: ${Math.floor(instanceProgress)}%)
    - å°æ¼”æŒ‡ä»¤ï¼š${director.directive}
    - ä¸Šä¸€ç« çµå°¾æ‡¸å¿µï¼š${cliffhangerNote} (é‡è¦ï¼è«‹ç·Šæ¥æ­¤è™•)
    - **ç©æ³•ç­–ç•¥**ï¼š${gameplayOps}
    
    ${dungeonContext}
    ${rulesContext}
    ${dungeonContext}
    ${rulesContext}
    ã€éšŠå‹ç‹€æ…‹ã€‘${characters.map(c => `- ${c.name}: ${c.status || 'æ­£å¸¸'}`).join('\n') || "æš«ç„¡è©³ç´°éšŠå‹è³‡è¨Š"}
    ã€äººéš›é—œä¿‚çŸ©é™£ (Relationship Graph)ã€‘
    ${relationships.length > 0 ? relationships.map(r => `${r.source} -> ${r.target}: [${r.type}] (ç‹€æ…‹: ${r.status}) | ${r.description}`).join('\n') : "æš«ç„¡é—œä¿‚è¨˜éŒ„ (è«‹åœ¨è¼¸å‡ºä¸­å»ºç«‹)"}
    
    ã€è¨­è¨ˆåœ–ã€‘${typeof blueprint === 'string' ? blueprint : JSON.stringify(blueprint)}
    ã€å‰æƒ…æè¦ã€‘${contextSummary}
    ã€ç·šç´¢ã€‘${clues.length > 0 ? clues.join('\n') : "ç„¡"}
    ã€æœ¬ç« ä»»å‹™ã€‘
    ${phase === 'setup' ? getDungeonReason(lastPlotState) : ''}
    
    ã€ä»»å‹™ã€‘
    1. **ç„¡ç¸«éŠœæ¥**ï¼šé–‹é ­å¿…é ˆç·Šæ¥ä¸Šä¸€ç« çš„æœ€å¾Œä¸€å€‹å‹•ä½œï¼Œ**åš´ç¦é‡è¤‡æå¯«ä¸Šä¸€ç« å·²ç¶“ç™¼ç”Ÿéçš„äº‹æƒ…**ã€‚
    2. æ ¹æ“šå‰¯æœ¬é€²åº¦ï¼Œæ¨é€²åŠ‡æƒ…ã€‚
    3. **æ©Ÿåˆ¶æ¼”ç¹¹**ï¼š${isRuleBased ? 'è®“ä¸»è§’åˆ†æè¦å‰‡é‚è¼¯ã€‚' : 'è®“ä¸»è§’åŸ·è¡Œä»»å‹™ç›®æ¨™ã€‚'}
    4. **äººç‰©äº’å‹•**ï¼šæœ¬ç« å¿…é ˆåŒ…å«è‡³å°‘ä¸€ä½éšŠå‹çš„é—œéµäº’å‹•ã€‚
    5. è¡çªè¨­è¨ˆèˆ‡æ„Ÿæƒ…è¦åŠƒã€‚
    
    å›å‚³ JSON: { 
        "chapter_title": "...", 
        "outline": "...", 
        "key_clue_action": "...", 
        "romance_moment": "...", 
        "relationship_updates": [ { "source": "...", "target": "...", "type": "...", "status": "Met/Close/Estranged", "description": "..." } ],
        "suggested_progress_increment": 5, 
        "should_finish_instance": false 
    }
    `;

    let plan;
    try {
        if (useDeepSeek) plan = await callDeepSeek("ä½ æ˜¯ä¸€ä½ç„¡é™æµç­–åŠƒã€‚", prompt, true);
        else {
            const model = getGeminiModel(true);
            const res = await model.generateContent(prompt);
            plan = cleanJson(res.response.text());
        }
    } catch (e) { plan = { chapter_title: "æ–°çš„ä¸€ç« ", outline: "æ¨é€²åŠ‡æƒ…...", suggested_progress_increment: 5 }; }

    return {
        ...plan,
        plot_state_update: {
            phase,
            instance_progress: instanceProgress,
            current_dungeon: currentDungeon,
            current_rules: currentRules,
            cycle_num: cycleNum,
            used_themes: usedThemes
        }
    };
};

const writeInfiniteChapter = async ({ novelContext, plan, prevText, tone, pov, useDeepSeek, director, currentDungeon }) => {
    const { title, genre } = novelContext;
    const { chapter_title, outline, key_clue_action, romance_moment, relationship_updates } = plan;
    const dynamicPrompt = getDynamicSettingPrompt(novelContext);
    const relationships = novelContext.relationships || [];

    const charismaInstruction = `
    ã€äººç‰©é«˜å…‰ (Charisma)ã€‘
    è«‹ç”¨åŠ›åˆ»ç•«ä¸»è§’çš„é­…åŠ›ã€‚
    - **å¼·å¤§**ï¼šä¸æ˜¯é æ•¸å€¼ï¼Œè€Œæ˜¯é è‡¨å±ä¸äº‚çš„æ°£å ´ã€‚
    - **ç ´ç¢**ï¼šå—å‚·æ™‚çš„éš±å¿ã€çœ¼ç¥ä¸­çš„ç–²æ†Šï¼Œè®“äººå¿ƒç–¼ï¼ˆè¦ªåª½ç²‰è¦–è§’ï¼‰ã€‚
    - **æ€§å¼µåŠ›**ï¼šèˆ‡ CP çš„äº’å‹•è¦ã€Œæ¬²ã€ï¼Œçœ¼ç¥æ‹‰çµ²ï¼Œè‚¢é«”æ¥è§¸è¦å¯«å‡ºé›»æµæ„Ÿã€‚
    `;

    const writerPrompt = `
    ${INFINITE_ANTI_CLICHE}
    ã€è³‡è¨Šã€‘${title} | ${director.phase}
    ã€é¢¨æ ¼ã€‘${tone} | ${pov}
    ${dynamicPrompt}

    ã€âš ï¸ è¨­å®šç´…ç·šã€‘
    1. **åš´å®ˆè¨­å®š**ï¼šå¦‚æœä¸»ä¸–ç•Œæ˜¯ã€Œç¾ä»£/ä½é­”ã€ï¼Œçµ•å°ä¸èƒ½å‡ºç¾ã€Œç«çƒè¡“ã€ã€ã€Œé£›åŠã€ç­‰é«˜é­”æå¯«ã€‚æ‰€æœ‰é“å…·å¿…é ˆç¬¦åˆè©²å‰¯æœ¬çš„æ™‚ä»£èƒŒæ™¯ã€‚
    2. **æ‹’çµ•æˆ°åŠ›è†¨è„¹**ï¼šä¸»è§’é€™æ™‚å€™é‚„æ˜¯åˆæœŸ/ä¸­æœŸï¼Œä¸è¦å¯«å¾—åƒæ»¿ç´šå¤§è™Ÿå± æ–°æ‰‹æ‘ã€‚
    3. **èµ·æ‰¿è½‰åˆ**ï¼šä¾ç…§ã€ŒPlannerçš„å¤§ç¶±ã€å¯«ï¼Œä¸è¦è‡ªå·±äº‚åŠ æ²’é ­æ²’å°¾çš„é­”æ³•è¨­å®šã€‚
    
    ã€äººéš›é—œä¿‚å®ˆé–€å“¡ (Relationship Guard)ã€‘
    ${relationships.map(r => `- ${r.source} èˆ‡ ${r.target} ç›®å‰é—œä¿‚: ${r.status} (${r.type})`).join('\n')}
    **å¼·åˆ¶è¦å‰‡**ï¼š
    - å¦‚æœé—œä¿‚ç‹€æ…‹æ˜¯ "Not Met" æˆ– "Stranger"ï¼š**åš´ç¦**å‡ºç¾ç†Ÿçµ¡çš„å°è©±ã€‚å¿…é ˆå…ˆæå¯«çœ¼ç¥æ¥è§¸ã€è©¦æ¢ã€è‡ªæˆ‘ä»‹ç´¹ã€‚
    - å¦‚æœé—œä¿‚æ˜¯ "Ex/å®¿æ•µ"ï¼šè¦‹é¢æ™‚å¿…é ˆæœ‰å°·å°¬æˆ–æ•µæ„ã€‚
    
    ã€æœ¬ç« åŠ‡æœ¬ (Planner's Outline)ã€‘
    ${outline}
    
    ã€å°æ¼”æŒ‡ä»¤ã€‘
    ${director.directive}
    ${charismaInstruction}
    
    ã€å ´æ™¯æ°›åœã€‘
    å‰¯æœ¬ï¼š${currentDungeon?.dungeon_name || "æœªçŸ¥é ˜åŸŸ"}
    (è«‹è‡ªè¡Œè…¦è£œç’°å¢ƒç´°ç¯€ï¼Œé‡é»æ˜¯ç‡Ÿé€ ææ€–/å£“æŠ‘/è©­ç•°çš„æ°›åœ)

    ã€âš ï¸ åš´æ ¼å¯«ä½œç¦ä»¤ (Critical)ã€‘
    1. **ç¦æ­¢é‡è¤‡å‰æ–‡**ï¼šè®€è€…å·²ç¶“çœ‹éä¸Šä¸€ç« äº†ã€‚**çµ•å°ä¸è¦**åœ¨é–‹é ­å¯«ã€Œå›é¡§ã€ã€ã€Œå‰æƒ…æè¦ã€æˆ–é‡æ–°æå¯«ä¸Šä¸€ç« çµå°¾å·²ç¶“ç™¼ç”Ÿéçš„å‹•ä½œã€‚
    2. **ç›´æ¥åˆ‡å…¥**ï¼šç›´æ¥å¾å¤§ç¶±çš„ç¬¬ä¸€å€‹æ–°å‹•ä½œé–‹å§‹å¯«ã€‚
    3. **å» AI å‘³**ï¼šæ‹’çµ•ç¸½çµæ€§èªå¥ï¼ˆå¦‚ã€Œé€™ä¸€åˆ‡æ‰å‰›å‰›é–‹å§‹ã€ï¼‰ã€‚
    4. **Show, Don't Tell**ï¼šä¸è¦å‘Šè¨´è®€è€…ã€Œå¾ˆå±éšªã€ï¼Œè¦å¯«å‡ºæ€ªç‰©è²¼åœ¨è€³é‚Šçš„å‘¼å¸è²ã€‚
    5. **å­—æ•¸**ï¼š2000+ã€‚
    6. **çµå°¾**ï¼šå¿…é ˆç•™æœ‰æ‡¸å¿µ (Cliffhanger)ã€‚
    
    å›å‚³ JSON: { "content": "...", "character_updates": [], "new_memories": [], "relationship_updates": ${JSON.stringify(relationship_updates || [])} }
    `;

    try {
        if (useDeepSeek) return await callDeepSeek("ä½ æ˜¯ä¸€ä½ç„¡é™æµå°èªªå®¶ã€‚", writerPrompt, true);
        const model = getGeminiModel(true);
        const res = await model.generateContent(writerPrompt);
        return cleanJson(res.response.text());
    } catch (e) {
        console.error("Infinite Writer Error:", e);
        throw e;
    }
};

export const generateInfiniteNextChapter = async (novelContext, previousContent, characters = [], memories = [], clues = [], tags = [], tone = "ä¸€èˆ¬", pov = "å¥³ä¸»", lastPlotState = null, useDeepSeek = false) => {
    const totalChapters = novelContext.targetEndingChapter || 200;
    const director = directorInfinite(novelContext.currentChapterIndex, lastPlotState, totalChapters);

    const blueprintStr = JSON.stringify(novelContext.design_blueprint || {});
    const prevText = previousContent.slice(-2000);

    const infinitePlan = await planInfinite({
        novelId: novelContext.id,
        novelContext,
        director,
        blueprint: blueprintStr,
        contextSummary: prevText,
        memories,
        clues,
        characters,
        tags,
        tone,
        lastPlotState,
        useDeepSeek
    });

    const writerResult = await writeInfiniteChapter({
        novelContext,
        plan: infinitePlan,
        prevText,
        tone,
        pov,
        useDeepSeek,
        director,
        currentDungeon: infinitePlan.plot_state_update.current_dungeon
    });

    if (writerResult.content && writerResult.content.length > 500) {
        writerResult.content = await polishContent(writerResult.content, tone, pov);
    }

    return {
        ...writerResult,
        plot_state: infinitePlan.plot_state_update,
        chapter_plan: infinitePlan
    };
};

const polishContent = async (draft, tone, pov) => {
    const model = getGeminiModel(false);
    const editorPrompt = `ä½ æ˜¯ä¸€ä½è³‡æ·±çš„ç¶²æ–‡ä¸»ç·¨ã€‚è«‹å°ä»¥ä¸‹åˆç¨¿é€²è¡Œã€æ·±åº¦æ½¤è‰²ã€‘ã€‚

${ANTI_CLICHE_INSTRUCTIONS}

ã€æ½¤è‰²ç›®æ¨™ã€‘
1. **å»é™¤AIå‘³**ï¼šæ¶ˆé™¤æ©Ÿæ¢°é‡è¤‡çš„å¥å¼ï¼Œå¢åŠ å£èªåŒ–èˆ‡ç”Ÿå‹•æ„Ÿã€‚
2. **å»é™¤å†—é¤˜**ï¼šåˆªé™¤ç„¡æ„ç¾©çš„éæ¸¡å¥èˆ‡é‡è¤‡çš„åŠ‡æƒ…å›é¡§ã€‚
3. **å¢å¼·ç•«é¢æ„Ÿ**ï¼šå¤šç”¨æ„Ÿå®˜æå¯«ï¼ˆè¦–è¦ºã€è½è¦ºã€è§¸è¦ºï¼‰ã€‚
4. **ç¬¦åˆåŸºèª¿**ï¼š${tone}ã€‚
5. **åš´æ ¼è¼¸å‡ºæ ¼å¼**ï¼š**åªè¼¸å‡ºæ½¤è‰²å¾Œçš„å°èªªæ­£æ–‡**ã€‚çµ•å°ä¸è¦è¼¸å‡ºã€Œã€æ·±åº¦æ½¤è‰²ç‰ˆã€‘ã€ã€ã€Œä»¥ä¸‹æ˜¯æ½¤è‰²å¾Œçš„å…§å®¹ã€ç­‰ä»»ä½•å‰è¨€å¾Œèªã€‚ä¸è¦è¼¸å‡ºæ¨™é¡Œã€‚

[åˆç¨¿]
${draft}`;

    try {
        const result = await model.generateContent(editorPrompt);
        let polished = result.response.text();

        polished = polished.replace(/^ã€.*?ã€‘\s*/g, '')
            .replace(/^\[.*?\]\s*/g, '')
            .replace(/^ä»¥ä¸‹æ˜¯.*?\n/g, '')
            .replace(/^Here is.*?\n/g, '')
            .trim();

        return polished;
    } catch (e) { return draft; }
};